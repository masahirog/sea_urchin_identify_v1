{% extends "base.html" %}

{% block title %}アノテーション編集 - ウニ生殖乳頭分析{% endblock %}

{% block extra_css %}
<style>
    /* メインコンテナ */
    .editor-main-container {
        display: flex;
        flex-direction: column;
        height: 90vh;
        gap: 0;
        padding: 0;
    }
    
    /* 上部コンテンツエリア */
    .top-content {
        display: flex;
        flex: 1;
        min-height: 0;
    }
    
    /* キャンバスエリア（最大化） */
    .canvas-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }
    
    .canvas-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #f8f9fa;
        position: relative;
        overflow: hidden;
    }
    
    .annotation-canvas {
        max-width: 100%;
        max-height: 100%;
        cursor: crosshair;
        background: white;
    }
    
    /* 右サイドバー */
    .control-sidebar {
        width: 280px;
        background: white;
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        flex-shrink: 0;
    }
    
    .sidebar-header {
        padding: 15px 20px;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        padding-bottom: 0;
    }
    
    /* ツールボタン */
    .tool-section {
        margin-bottom: 25px;
    }
    
    .tool-section h6 {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 12px;
        font-weight: normal;
    }
    
    .tool-buttons {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
    }
    
    .tool-btn {
        flex: 1;
        height: 50px;
        border: 2px solid #dee2e6;
        background: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.2rem;
    }

    .tool-btn:hover {
        background: #f8f9fa;
        transform: translateY(-2px);
        border-color: #adb5bd;
    }

    .tool-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }
    
    /* クラス選択 */
    .class-buttons {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .class-btn {
        padding: 10px 15px;
        border: 2px solid #dee2e6;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.875rem;
    }
    
    .class-btn:hover {
        background: #f8f9fa;
    }
    
    .class-btn.active {
        background: #e7f3ff;
        border-color: #007bff;
    }
    
    .class-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    .class-icon.male { background: #007bff; }
    .class-icon.female { background: #dc3545; }
    .class-icon.madreporite { background: #28a745; }
    
    /* アノテーション統計 */
    .annotation-stats {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
    
    .stat-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-size: 0.875rem;
    }
    
    .stat-row:last-child {
        margin-bottom: 0;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
        font-weight: bold;
    }
    
    /* 保存ボタンセクション */
    .save-section {
        margin-top: 20px;
        padding-top: 20px;
        padding-bottom: 20px;
        border-top: 1px solid #dee2e6;
    }
    
    .btn-save-next {
        background: #5b72ee;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        width: 100%;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-save-next:hover {
        background: #4a5fdb;
        transform: translateY(-1px);
    }
    
    /* 下部画像リスト */
    .bottom-panel {
        background: white;
        border-top: 1px solid #dee2e6;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        flex-shrink: 0;
    }
    
    /* 画像リストスクローラー */
    .image-list-container {
        position: relative;
        background: white;
        display: flex;
        align-items: center;
        padding: 10px 0;
    }
    
    /* 左側のコントロール */
    .list-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 0 15px;
        min-width: 150px;
        border-right: 1px solid #dee2e6;
        margin-right: 15px;
    }
    
    .list-info {
        font-size: 0.875rem;
        color: #495057;
    }
    
    .progress-wrapper {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }
    
    .progress-text {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .progress {
        width: 100px;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
    }
    
    .progress-bar {
        height: 100%;
        background: #28a745;
        transition: width 0.3s ease;
    }
    
    .nav-buttons {
        display: flex;
        gap: 5px;
    }
    
    .nav-btn {
        padding: 5px 10px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    
    .nav-btn:hover:not(:disabled) {
        background: #5a6268;
        transform: translateY(-1px);
    }
    
    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* 画像スクロール部分 */
    .image-list-scroll {
        display: flex;
        gap: 5px;
        overflow-x: auto;
        padding: 0 10px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        flex: 1;
    }
    
    .image-list-scroll::-webkit-scrollbar {
        height: 6px;
    }
    
    .image-list-scroll::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    .image-list-scroll::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    /* 画像サムネイル */
    .image-thumbnail-card {
        flex-shrink: 0;
        width: 120px;
        height: 80px;
        border: 3px solid transparent;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        background: #f8f9fa;
    }
    
    .image-thumbnail-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .image-thumbnail-card.active {
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    .thumbnail-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    
    /* アノテーション状態インジケーター */
    .annotation-indicator {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: #28a745;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: bold;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .no-annotation-indicator {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 10px;
        height: 10px;
        background: #ffc107;
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    /* レスポンシブ */
    @media (max-width: 1200px) {
        .control-sidebar {
            width: 240px;
        }
    }
    
    @media (max-width: 992px) {
        .editor-main-container {
            flex-direction: column;
        }
        
        .control-sidebar {
            width: 100%;
            max-height: 300px;
        }
        
        .image-thumbnail-card {
            width: 100px;
            height: 75px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-main-container">
    <!-- 上部コンテンツ -->
    <div class="top-content">
        <!-- メインキャンバスエリア -->
        <div class="canvas-area">
            <!-- キャンバスコンテナ -->
            <div class="canvas-container">
                <canvas id="annotationCanvas" class="annotation-canvas"></canvas>
            </div>
        </div>
        
        <!-- 右サイドバー -->
        <div class="control-sidebar">
            <div class="sidebar-header">
                <span id="currentImageName">画像を選択してください</span>
                <button class="btn-close btn-sm" onclick="window.location.href='/annotation/images/'"></button>
            </div>
            
            <div class="sidebar-content">
                <!-- ツールセクション -->
                <div class="tool-section">
                    <div class="tool-buttons">
                        <button class="tool-btn active" data-tool="draw" title="新規作成">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="tool-btn" data-tool="select" title="移動">
                            <i class="fas fa-arrows-alt"></i>
                        </button>
                        <button class="tool-btn" data-tool="delete" title="削除">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>
                </div>
                
                <!-- クラス選択 -->
                <div class="tool-section">
                    <h6>クラス選択</h6>
                    <div class="class-buttons">
                        <div class="class-btn active" data-class="0">
                            <span class="class-icon male"></span>
                            <span>雄の生殖乳頭</span>
                        </div>
                        <div class="class-btn" data-class="1">
                            <span class="class-icon female"></span>
                            <span>雌の生殖乳頭</span>
                        </div>
                        <div class="class-btn" data-class="2">
                            <span class="class-icon madreporite"></span>
                            <span>多孔板</span>
                        </div>
                    </div>
                </div>
                
                <!-- アノテーション数 -->
                <div class="tool-section">
                    <h6>アノテーション数</h6>
                    <div class="annotation-stats">
                        <div class="stat-row">
                            <span>雄の生殖乳頭</span>
                            <span class="badge bg-primary" id="maleCount">0</span>
                        </div>
                        <div class="stat-row">
                            <span>雌の生殖乳頭</span>
                            <span class="badge bg-danger" id="femaleCount">0</span>
                        </div>
                        <div class="stat-row">
                            <span>多孔板</span>
                            <span class="badge bg-success" id="madreporiteCount">0</span>
                        </div>
                        <div class="stat-row">
                            <span>合計</span>
                            <span id="totalAnnotations">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- 保存ボタン -->
                <div class="save-section">
                    <button class="btn-save-next" id="saveCurrentBtn">
                        <i class="fas fa-save"></i> 保存して次へ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 下部画像リストパネル -->
    <div class="bottom-panel">
        <div class="image-list-container">
            <!-- 左側のコントロール -->
            <div class="list-controls">
                <div class="progress-wrapper">
                    <div class="progress-text">
                        進歩: <strong id="completedCount">0</strong> / <strong id="totalCount">0</strong>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn" id="prevImageBtn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn" id="nextImageBtn" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- 画像リスト -->
            <div class="image-list-scroll" id="imageListScroll">
                <!-- 画像サムネイルがここに表示される -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
import { YoloAnnotator } from '/static/js/YoloAnnotator.js';
import { showLoading, hideLoading, showSuccessMessage, showErrorMessage } from '/static/js/utilities.js';

// グローバル変数
let imageList = [];
let currentImageIndex = -1;
let annotator = null;
let hasUnsavedChanges = false;
let currentClass = 0;

// 初期画像ID（URLパラメータから取得）
const urlParams = new URLSearchParams(window.location.search);
const initialImageId = urlParams.get('image_id');

// 初期化
document.addEventListener('DOMContentLoaded', function() {
    // DOM要素の存在確認
    const requiredElements = ['completedCount', 'totalCount', 'progressBar'];
    const missingElements = requiredElements.filter(id => !document.getElementById(id));
    
    if (missingElements.length > 0) {
        console.error('必要な要素が見つかりません:', missingElements);
        showErrorMessage('ページの初期化エラーが発生しました');
        return;
    }
    
    setupEventListeners();
    loadImageList();
    setupKeyboardShortcuts();
});

// イベントリスナーのセットアップ
function setupEventListeners() {
    // ツールボタン
    document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            if (annotator) {
                const tool = this.dataset.tool;
                if (tool === 'draw') {
                    annotator.setMode('create');
                } else if (tool === 'select') {
                    annotator.setMode('edit');
                } else if (tool === 'delete') {
                    annotator.setMode('delete');
                }
            }
        });
    });
    
    // クラス選択（新しい実装）
    document.querySelectorAll('.class-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentClass = parseInt(this.dataset.class);
            if (annotator) {
                annotator.setCurrentClass(currentClass);
            }
        });
    });
    
    // ナビゲーションボタン
    document.getElementById('prevImageBtn').addEventListener('click', () => navigateImage(-1));
    document.getElementById('nextImageBtn').addEventListener('click', () => navigateImage(1));
    
    // 保存ボタン
    document.getElementById('saveCurrentBtn').addEventListener('click', saveAndNext);
    
    // ページ離脱時の確認
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
}

// キーボードショートカット
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl+S: 保存
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveCurrentImage();
        }
        // 矢印キー: ナビゲーション
        else if (e.key === 'ArrowLeft' && !e.ctrlKey && !e.shiftKey) {
            navigateImage(-1);
        }
        else if (e.key === 'ArrowRight' && !e.ctrlKey && !e.shiftKey) {
            navigateImage(1);
        }
        // 数字キー: クラス選択
        else if (e.key === '1') {
            document.querySelector('.class-btn[data-class="0"]').click();
        }
        else if (e.key === '2') {
            document.querySelector('.class-btn[data-class="1"]').click();
        }
        else if (e.key === '3') {
            document.querySelector('.class-btn[data-class="2"]').click();
        }
    });
}

// 画像リストの読み込み
async function loadImageList() {
    try {
        showLoading('画像一覧を読み込み中...');
        
        const response = await fetch('/annotation/editor/list-for-edit');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.images) {
            throw new Error('画像データが取得できませんでした');
        }
        
        imageList = data.images;
        updateImageListUI();
        
        // 初期画像の選択
        if (initialImageId) {
            const index = imageList.findIndex(img => img.id === initialImageId);
            if (index !== -1) {
                selectImage(index);
            } else if (imageList.length > 0) {
                selectImage(0);
            }
        } else if (imageList.length > 0) {
            selectImage(0);
        }
        
        hideLoading();
    } catch (error) {
        hideLoading();
        console.error('画像リスト読み込みエラー:', error);
        showErrorMessage('画像一覧の読み込みエラー: ' + error.message);
    }
}

// 画像リストUI更新
function updateImageListUI() {
    const listContainer = document.getElementById('imageListScroll');
    
    if (!listContainer) {
        console.error('画像リストコンテナが見つかりません');
        return;
    }
    
    listContainer.innerHTML = '';
    
    imageList.forEach((image, index) => {
        const card = document.createElement('div');
        card.className = 'image-thumbnail-card';
        card.dataset.index = index;
        
        const indicator = image.annotated ? 
            `<span class="annotation-indicator">${image.annotation_count}</span>` : 
            '<span class="no-annotation-indicator"></span>';
        
        card.innerHTML = `
            <img src="${image.thumbnail_url}" class="thumbnail-img" alt="${image.original_name}">
            ${indicator}
        `;
        
        card.addEventListener('click', () => selectImage(index));
        listContainer.appendChild(card);
    });
    
    updateProgress();
}

// 画像選択
async function selectImage(index) {
    // 未保存の変更がある場合は確認
    if (hasUnsavedChanges) {
        if (!confirm('未保存の変更があります。破棄して続行しますか？')) {
            return;
        }
    }
    
    currentImageIndex = index;
    const image = imageList[index];
    
    // サムネイルのアクティブ状態を更新
    document.querySelectorAll('.image-thumbnail-card').forEach((card, i) => {
        if (i === index) {
            card.classList.add('active');
            // 選択した画像を表示領域の中央に
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        } else {
            card.classList.remove('active');
        }
    });
    
    // ナビゲーションボタンの状態更新
    document.getElementById('prevImageBtn').disabled = index === 0;
    document.getElementById('nextImageBtn').disabled = index === imageList.length - 1;
    
    // 画像名を表示
    document.getElementById('currentImageName').textContent = image.original_name;
    
    // 画像とアノテーションを読み込み
    await loadImageAndAnnotations(image.id);
}

// 画像とアノテーションの読み込み
async function loadImageAndAnnotations(imageId) {
    try {
        showLoading('画像を読み込み中...');
        
        const response = await fetch(`/annotation/editor/load/${imageId}`);
        const data = await response.json();
        
        // キャンバスに画像を読み込み
        const canvas = document.getElementById('annotationCanvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.crossOrigin = "anonymous";
        
        img.onload = function() {
            // キャンバスサイズを画像に合わせる
            canvas.width = img.width;
            canvas.height = img.height;
            
            // コンテナのサイズを取得
            const container = document.querySelector('.canvas-container');
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // アスペクト比を保持してスケール（最大限に拡大）
            const scale = Math.min(containerWidth / canvas.width, containerHeight / canvas.height);
            
            canvas.style.width = (canvas.width * scale) + 'px';
            canvas.style.height = (canvas.height * scale) + 'px';
            
            ctx.drawImage(img, 0, 0);
            
            // アノテーターを初期化
            annotator = new YoloAnnotator(canvas, img);
            annotator.setMode('create');
            annotator.setCurrentClass(currentClass);
            
            // 既存のアノテーションを読み込み
            if (data.annotations) {
                annotator.loadFromYoloFormat(data.annotations);
            }
            
            // アノテーション変更時のコールバック
            annotator.onAnnotationsChanged = function() {
                updateAnnotationCounts();
                hasUnsavedChanges = true;
            };
            
            updateAnnotationCounts();
            hasUnsavedChanges = false;
            hideLoading();
        };
        
        img.onerror = function() {
            hideLoading();
            showErrorMessage('画像の読み込みに失敗しました');
        };
        
        img.src = data.image_url;
        
    } catch (error) {
        hideLoading();
        showErrorMessage('画像読み込みエラー: ' + error.message);
    }
}

// アノテーション数更新
function updateAnnotationCounts() {
    if (!annotator) return;
    
    let maleCount = 0;
    let femaleCount = 0;
    let madreporiteCount = 0;
    
    annotator.annotations.forEach(ann => {
        if (ann.class === 0) maleCount++;
        else if (ann.class === 1) femaleCount++;
        else if (ann.class === 2) madreporiteCount++;
    });
    
    document.getElementById('maleCount').textContent = maleCount;
    document.getElementById('femaleCount').textContent = femaleCount;
    document.getElementById('madreporiteCount').textContent = madreporiteCount;
    document.getElementById('totalAnnotations').textContent = maleCount + femaleCount + madreporiteCount;
}

// 現在の画像を保存
async function saveCurrentImage() {
    if (!annotator || currentImageIndex === -1) return;
    
    const currentImage = imageList[currentImageIndex];
    const yoloData = annotator.exportToYoloFormat();
    
    try {
        showLoading('保存中...');
        
        const response = await fetch(`/annotation/editor/save/${currentImage.id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                annotations: yoloData,
                annotation_count: annotator.annotations.length
            })
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.success) {
            showSuccessMessage('保存しました');
            hasUnsavedChanges = false;
            
            // リストの情報を更新
            imageList[currentImageIndex].annotated = data.annotation_count > 0;
            imageList[currentImageIndex].annotation_count = data.annotation_count;
            updateImageListUI();
            
            return true;
        } else {
            showErrorMessage(data.error || '保存に失敗しました');
            return false;
        }
    } catch (error) {
        hideLoading();
        showErrorMessage('保存エラー: ' + error.message);
        return false;
    }
}

// 保存して次へ
async function saveAndNext() {
    const saved = await saveCurrentImage();
    if (saved) {
        navigateImage(1);
    }
}

// 画像ナビゲーション
function navigateImage(direction) {
    const newIndex = currentImageIndex + direction;
    if (newIndex >= 0 && newIndex < imageList.length) {
        selectImage(newIndex);
    }
}

// 進捗更新
function updateProgress() {
    const completedCountEl = document.getElementById('completedCount');
    const totalCountEl = document.getElementById('totalCount');
    const progressBarEl = document.getElementById('progressBar');
    
    if (!completedCountEl || !totalCountEl || !progressBarEl) {
        console.error('進捗表示要素が見つかりません');
        return;
    }
    
    const annotatedCount = imageList.filter(img => img.annotated).length;
    const totalCount = imageList.length;
    const rate = totalCount > 0 ? Math.round((annotatedCount / totalCount) * 100) : 0;
    
    completedCountEl.textContent = annotatedCount;
    totalCountEl.textContent = totalCount;
    progressBarEl.style.width = rate + '%';
}

</script>
{% endblock %}