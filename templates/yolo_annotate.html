{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
  <h1>生殖乳頭アノテーションツール</h1>
  
  <div class="row mt-4">
    <div class="col-md-9">
      <div class="card mb-4">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5>画像アノテーション</h5>
            <div>
              <select id="image-selector" class="form-select form-select-sm" style="width: 300px;">
                <option value="">-- 画像を選択 --</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card-body text-center">
          <div id="annotation-container" style="position: relative; display: inline-block;">
            <img id="annotation-image" src="" alt="アノテーション画像" style="max-width: 100%; display: none;">
            <canvas id="annotation-canvas" style="position: absolute; top: 0; left: 0; cursor: crosshair;"></canvas>
          </div>
          
          <div id="no-image-message">
            <p class="text-muted">左側のセレクトボックスから画像を選択してください。</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card mb-4">
        <div class="card-header">
          <h5>アノテーション操作</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="class-selector" class="form-label">クラス:</label>
            <select id="class-selector" class="form-select">
              <option value="0" selected>生殖乳頭</option>
            </select>
          </div>
          
          <div class="d-grid gap-2 mb-3">
            <button id="save-btn" class="btn btn-primary">保存</button>
            <button id="clear-btn" class="btn btn-danger">全て消去</button>
          </div>
          
          <div class="alert alert-info">
            <strong>操作方法:</strong>
            <ul>
              <li>ドラッグして矩形を描画</li>
              <li>クリックで矩形を選択</li>
              <li>DELキーで選択した矩形を削除</li>
            </ul>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h5>アノテーション一覧</h5>
        </div>
        <div class="card-body p-0">
          <ul id="annotation-list" class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
            <!-- アノテーション一覧がここに表示されます -->
            <li class="list-group-item text-center text-muted">アノテーションがありません</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row mt-4 mb-5">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5>新しい画像のアップロード</h5>
        </div>
        <div class="card-body">
          <form id="upload-form">
            <div class="mb-3">
              <label for="upload-images" class="form-label">アノテーション用の画像をアップロード</label>
              <input class="form-control" type="file" id="upload-images" multiple accept="image/*">
            </div>
            
            <div class="d-grid gap-2">
              <button type="button" id="upload-btn" class="btn btn-primary">アップロード</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 変数の初期化
    let currentImage = null;
    let annotations = [];
    let startX, startY, endX, endY;
    let isDrawing = false;
    let selectedAnnotationIndex = -1;
    
    // 要素の取得
    const canvas = document.getElementById('annotation-canvas');
    const ctx = canvas.getContext('2d');
    const image = document.getElementById('annotation-image');
    const imageSelector = document.getElementById('image-selector');
    const annotationList = document.getElementById('annotation-list');
    const saveBtn = document.getElementById('save-btn');
    const clearBtn = document.getElementById('clear-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const noImageMessage = document.getElementById('no-image-message');
    
    // 画像リストの読み込み
    function loadImageList() {
      fetch('/yolo/api/images')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success' && data.images) {
            // セレクトボックスのクリア
            imageSelector.innerHTML = '<option value="">-- 画像を選択 --</option>';
            
            // 画像オプションの追加
            data.images.forEach(img => {
              const option = document.createElement('option');
              option.value = img.id;
              option.textContent = img.filename;
              option.dataset.url = img.url;
              imageSelector.appendChild(option);
            });
          }
        })
        .catch(error => {
          console.error('画像リスト取得エラー:', error);
          alert('画像リストの取得中にエラーが発生しました。');
        });
    }
    
    // 画像セレクター変更イベント
    imageSelector.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption.value) {
        // 現在の画像IDを設定
        currentImage = {
          id: selectedOption.value,
          url: selectedOption.dataset.url
        };
        
        // 画像の読み込み
        image.src = currentImage.url;
        image.style.display = 'block';
        noImageMessage.style.display = 'none';
        
        // 画像読み込み完了時の処理
        image.onload = function() {
          // キャンバスサイズの設定
          canvas.width = image.width;
          canvas.height = image.height;
          
          // アノテーションの読み込み
          loadAnnotations(currentImage.id);
        };
      } else {
        // 画像選択がクリアされた場合
        currentImage = null;
        image.style.display = 'none';
        noImageMessage.style.display = 'block';
        canvas.width = 0;
        canvas.height = 0;
        annotations = [];
        updateAnnotationList();
      }
    });
    
    // アノテーションの読み込み
    function loadAnnotations(imageId) {
      fetch(`/yolo/api/annotations/${imageId}`)
        .then(response => response.json())
        .then(data => {
          annotations = data.annotations || [];
          updateAnnotationList();
          drawAnnotations();
        })
        .catch(error => {
          console.error('アノテーション読み込みエラー:', error);
          annotations = [];
          updateAnnotationList();
        });
    }
    
    // キャンバスマウスダウンイベント
    canvas.addEventListener('mousedown', function(e) {
      if (!currentImage) return;
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      // 既存のアノテーションの選択を確認
      selectedAnnotationIndex = findAnnotationAt(x, y);
      
      if (selectedAnnotationIndex >= 0) {
        // 既存のアノテーションを選択
        drawAnnotations();
        highlightAnnotation(selectedAnnotationIndex);
      } else {
        // 新しいアノテーションの開始
        startX = x;
        startY = y;
        isDrawing = true;
      }
    });
    
    // キャンバスマウス移動イベント
    canvas.addEventListener('mousemove', function(e) {
      if (!isDrawing) return;
      
      const rect = canvas.getBoundingClientRect();
      endX = e.clientX - rect.left;
      endY = e.clientY - rect.top;
      
      // アノテーションの描画
      drawAnnotations();
      drawRect(startX, startY, endX, endY);
    });
    
    // キャンバスマウスアップイベント
    canvas.addEventListener('mouseup', function() {
      if (!isDrawing) return;
      
      isDrawing = false;
      
      // 十分な大きさがある場合のみアノテーションを追加
      if (Math.abs(endX - startX) > 5 && Math.abs(endY - startY) > 5) {
        const [x1, y1, x2, y2] = normalizeCoordinates(startX, startY, endX, endY);
        
        annotations.push({
          id: Date.now().toString(),
          class: document.getElementById('class-selector').value,
          x1, y1, x2, y2
        });
        
        updateAnnotationList();
        drawAnnotations();
      }
    });
    
    // キーボードイベント（DELキーでアノテーション削除）
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Delete' && selectedAnnotationIndex >= 0) {
        annotations.splice(selectedAnnotationIndex, 1);
        selectedAnnotationIndex = -1;
        updateAnnotationList();
        drawAnnotations();
      }
    });
    
    // アノテーション保存ボタン
    saveBtn.addEventListener('click', function() {
      if (!currentImage) {
        alert('画像が選択されていません。');
        return;
      }
      
      fetch(`/yolo/api/annotations/${currentImage.id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ annotations })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert('アノテーションを保存しました。');
        } else {
          alert('エラー: ' + data.message);
        }
      })
      .catch(error => {
        console.error('保存エラー:', error);
        alert('アノテーションの保存中にエラーが発生しました。');
      });
    });
    
    // 全て消去ボタン
    clearBtn.addEventListener('click', function() {
      if (confirm('全てのアノテーションを消去しますか？')) {
        annotations = [];
        selectedAnnotationIndex = -1;
        updateAnnotationList();
        drawAnnotations();
      }
    });
    
    // 画像アップロードボタン
    uploadBtn.addEventListener('click', function() {
      const fileInput = document.getElementById('upload-images');
      if (fileInput.files.length === 0) {
        alert('アップロードする画像を選択してください。');
        return;
      }
      
      const formData = new FormData();
      for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('images[]', fileInput.files[i]);
      }
      
      fetch('/upload_images', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert('画像のアップロードが完了しました。');
          // 画像リストの再読み込み
          loadImageList();
          // フォームのリセット
          document.getElementById('upload-form').reset();
        } else {
          alert('エラー: ' + data.message);
        }
      })
      .catch(error => {
        console.error('アップロードエラー:', error);
        alert('画像のアップロード中にエラーが発生しました。');
      });
    });
    
    // アノテーションリストの更新
    function updateAnnotationList() {
      if (annotations.length === 0) {
        annotationList.innerHTML = '<li class="list-group-item text-center text-muted">アノテーションがありません</li>';
        return;
      }
      
      annotationList.innerHTML = '';
      
      annotations.forEach((ann, index) => {
        const item = document.createElement('li');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        if (index === selectedAnnotationIndex) {
          item.classList.add('active');
        }
        
        const className = ann.class === '0' ? '生殖乳頭' : 'クラス ' + ann.class;
        
        item.innerHTML = `
          <div>
            <span class="badge bg-primary me-2">${index + 1}</span>
            ${className}
          </div>
          <button class="btn btn-sm btn-outline-danger delete-ann" data-index="${index}">削除</button>
        `;
        
        annotationList.appendChild(item);
        
        // クリックイベントを追加
        item.addEventListener('click', function() {
          selectedAnnotationIndex = index;
          drawAnnotations();
          highlightAnnotation(index);
          updateAnnotationList();
        });
      });
      
      // 削除ボタンのイベント
      document.querySelectorAll('.delete-ann').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const index = parseInt(this.dataset.index);
          annotations.splice(index, 1);
          if (selectedAnnotationIndex === index) {
            selectedAnnotationIndex = -1;
          } else if (selectedAnnotationIndex > index) {
            selectedAnnotationIndex--;
          }
          updateAnnotationList();
          drawAnnotations();
        });
      });
    }
    
    // アノテーションの描画
    function drawAnnotations() {
      if (!canvas.width || !canvas.height) return;
      
      // キャンバスのクリア
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 全てのアノテーションを描画
      annotations.forEach((ann, index) => {
        const color = index === selectedAnnotationIndex ? '#ff0000' : '#00ff00';
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.strokeRect(ann.x1, ann.y1, ann.x2 - ann.x1, ann.y2 - ann.y1);
        
        // ラベルの描画
        ctx.fillStyle = color;
        ctx.font = '12px Arial';
        const className = ann.class === '0' ? '生殖乳頭' : 'クラス ' + ann.class;
        ctx.fillText(className, ann.x1, ann.y1 - 5);
              });
            }
            
            // 新しい矩形の描画
            function drawRect(x1, y1, x2, y2) {
              ctx.strokeStyle = '#0000ff';
              ctx.lineWidth = 2;
              ctx.strokeRect(
                Math.min(x1, x2),
                Math.min(y1, y2),
                Math.abs(x2 - x1),
                Math.abs(y2 - y1)
              );
            }
            
            // 選択されたアノテーションのハイライト
            function highlightAnnotation(index) {
              const ann = annotations[index];
              if (!ann) return;
              
              ctx.strokeStyle = '#ff0000';
              ctx.lineWidth = 3;
              ctx.strokeRect(ann.x1, ann.y1, ann.x2 - ann.x1, ann.y2 - ann.y1);
              
              // 選択ハンドルの描画
              const handleSize = 6;
              const handles = [
                { x: ann.x1, y: ann.y1 },  // 左上
                { x: ann.x2, y: ann.y1 },  // 右上
                { x: ann.x1, y: ann.y2 },  // 左下
                { x: ann.x2, y: ann.y2 }   // 右下
              ];
              
              ctx.fillStyle = '#ff0000';
              handles.forEach(handle => {
                ctx.fillRect(
                  handle.x - handleSize / 2,
                  handle.y - handleSize / 2,
                  handleSize,
                  handleSize
                );
              });
            }
            
            // 座標の正規化（左上から右下の形式に）
            function normalizeCoordinates(x1, y1, x2, y2) {
              return [
                Math.min(x1, x2),
                Math.min(y1, y2),
                Math.max(x1, x2),
                Math.max(y1, y2)
              ];
            }
            
            // 指定した座標にあるアノテーションを探す
            function findAnnotationAt(x, y) {
              for (let i = annotations.length - 1; i >= 0; i--) {
                const ann = annotations[i];
                if (x >= ann.x1 && x <= ann.x2 && y >= ann.y1 && y <= ann.y2) {
                  return i;
                }
              }
              return -1;
            }
            
            // 画像アップロードのルートを作成
            async function createUploadRoute() {
              const form = document.getElementById('upload-form');
              form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const fileInput = document.getElementById('upload-images');
                if (fileInput.files.length === 0) {
                  alert('アップロードする画像を選択してください。');
                  return;
                }
                
                const formData = new FormData();
                for (let i = 0; i < fileInput.files.length; i++) {
                  formData.append('images[]', fileInput.files[i]);
                }
                
                try {
                  const response = await fetch('/yolo/upload_images', {
                    method: 'POST',
                    body: formData
                  });
                  
                  const data = await response.json();
                  if (data.status === 'success') {
                    alert('画像のアップロードが完了しました。');
                    // 画像リストの再読み込み
                    loadImageList();
                    // フォームのリセット
                    form.reset();
                  } else {
                    alert('エラー: ' + data.message);
                  }
                } catch (error) {
                  console.error('アップロードエラー:', error);
                  alert('画像のアップロード中にエラーが発生しました。');
                }
              });
            }
            
            // 初期化
            loadImageList();
            createUploadRoute();
          });
        </script>
        {% endblock %}

          