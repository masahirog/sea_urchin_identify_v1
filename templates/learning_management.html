{% extends "base.html" %}

{% block title %}統合学習システム - ウニ生殖乳頭分析システム{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<!-- 統合学習システムのメインコンテナ -->
<div class="container">
    <!-- フェーズインジケーター -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title text-center mb-4">
                        <i class="fas fa-graduation-cap me-2"></i>統合学習システム
                    </h4>
                    
                    <!-- フェーズステップ表示（修正版） -->
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div id="phase-preparation" class="phase-indicator active clickable-phase">
                                <div class="phase-icon">
                                    <i class="fas fa-database fa-2x"></i>
                                </div>
                                <h6 class="mt-2">データ準備</h6>
                                <small class="text-muted">アップロード・アノテーション</small>
                                <!-- 進捗ドット追加 -->
                                <div class="phase-progress mt-2">
                                    <span class="progress-dot active"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div id="phase-training" class="phase-indicator clickable-phase">
                                <div class="phase-icon">
                                    <i class="fas fa-brain fa-2x"></i>
                                </div>
                                <h6 class="mt-2">AI学習</h6>
                                <small class="text-muted">モデル訓練・基本評価</small>
                                <!-- 進捗ドット追加 -->
                                <div class="phase-progress mt-2">
                                    <span class="progress-dot"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div id="phase-analysis" class="phase-indicator clickable-phase">
                                <div class="phase-icon">
                                    <i class="fas fa-chart-line fa-2x"></i>
                                </div>
                                <h6 class="mt-2">結果分析</h6>
                                <small class="text-muted">詳細評価・改善提案</small>
                                <!-- 進捗ドット追加 -->
                                <div class="phase-progress mt-2">
                                    <span class="progress-dot"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 統合ステータス表示 -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="unified-status" class="alert alert-secondary d-none" role="alert">
                準備完了
            </div>
            <div id="unified-progress" class="d-none">
                <div class="progress mb-3">
                    <div id="unified-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- フェーズ1: データ準備セクション -->
    <div id="data-preparation-section" class="phase-section">
        <div class="row">
            <!-- データアップロード -->
            <div class="col-md-4">
                <div class="card dataset-stat-card">
                    <div class="card-header">
                        <h5><i class="fas fa-cloud-upload-alt me-2"></i>データアップロード</h5>
                    </div>
                    <div class="card-body">
                        <form id="unifiedDataUploadForm">
                            <div class="mb-3">
                                <label for="dataFiles" class="form-label">画像ファイル</label>
                                <input type="file" id="dataFiles" name="images" accept="image/*" 
                                       class="form-control" multiple>
                                <div class="form-text">生殖乳頭の画像を選択（複数選択可能）</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="dataGender" class="form-label">性別</label>
                                <select id="dataGender" name="gender" class="form-select">
                                    <option value="male">オス</option>
                                    <option value="female">メス</option>
                                    <option value="unknown">不明（後で分類）</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-upload me-1"></i>アップロード
                            </button>
                        </form>
                        
                        <!-- アップロード進捗 -->
                        <div id="upload-progress" class="mt-3 d-none">
                            <div class="progress">
                                <div id="upload-progress-bar" class="progress-bar" style="width: 0%"></div>
                            </div>
                            <small id="upload-status" class="text-muted">アップロード中...</small>
                        </div>
                    </div>
                </div>
                
                <!-- データセット統計 -->
                <div class="card dataset-stat-card">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-pie me-2"></i>データセット状況</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-3">
                                <div class="stat-number text-primary" id="dataset-male-count">0</div>
                                <div class="stat-label">オス</div>
                            </div>
                            <div class="col-3">
                                <div class="stat-number text-danger" id="dataset-female-count">0</div>
                                <div class="stat-label">メス</div>
                            </div>
                            <div class="col-3">
                                <div class="stat-number text-success" id="dataset-annotated-count">0</div>
                                <div class="stat-label">アノテーション済み</div>
                            </div>
                            <div class="col-3">
                                <div class="stat-number text-info" id="dataset-readiness">0%</div>
                                <div class="stat-label">準備完了度</div>
                            </div>
                        </div>
                        
                        <!-- 準備完了チェック -->
                        <div id="readiness-check" class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="readiness-message">データ準備中...</span>
                        </div>
                        
                        <button class="btn btn-outline-secondary btn-sm w-100" id="refresh-dataset-btn">
                            <i class="fas fa-sync-alt me-1"></i>状況更新
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- データ一覧・アノテーション -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-images me-2"></i>学習データ一覧</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="dataFilter" id="filter-all" value="all" checked>
                            <label class="btn btn-outline-secondary" for="filter-all">全て</label>
                            
                            <input type="radio" class="btn-check" name="dataFilter" id="filter-male" value="male">
                            <label class="btn btn-outline-primary" for="filter-male">オス</label>
                            
                            <input type="radio" class="btn-check" name="dataFilter" id="filter-female" value="female">
                            <label class="btn btn-outline-danger" for="filter-female">メス</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="learning-data-container" class="image-container">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-database fa-3x mb-3"></i>
                                <p>学習データをアップロードすると、ここに表示されます</p>
                                <small class="text-muted">画像をクリックしてアノテーションを作成できます</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- アノテーション管理 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-object-group me-2"></i>アノテーション管理</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>アノテーションについて:</strong>
                            <p class="mb-0">画像内の生殖乳頭を囲むアノテーション（バウンディングボックス）は学習精度を向上させます。</p>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-pen-square fa-3x mb-3 text-primary"></i>
                                        <h5>手動アノテーション</h5>
                                        <p class="small">画像一覧から個別に生殖乳頭を囲み、アノテーションを作成します。</p>
                                        <a href="/yolo/annotate" class="btn btn-primary" target="_blank">
                                            <i class="fas fa-external-link-alt me-1"></i> アノテーションツールを開く
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-magic fa-3x mb-3 text-success"></i>
                                        <h5>データセット準備</h5>
                                        <p class="small">アノテーション済み画像をYOLO用のデータセットに変換します。</p>
                                        <button id="prepare-dataset-btn" class="btn btn-success">
                                            <i class="fas fa-cogs me-1"></i> データセット準備
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- データ準備完了時のアクション -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button id="start-unified-training-btn" class="btn btn-success btn-lg d-none">
                    <i class="fas fa-play me-2"></i>統合学習を開始
                </button>
            </div>
        </div>
    </div>

    <!-- フェーズ2: 学習実行セクション（非表示状態で開始） -->
    <div id="training-section" class="phase-section d-none">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-brain me-2"></i>AI学習実行中</h5>
                    </div>
                    <div class="card-body">
                        <div id="training-details">
                            <p><strong>学習データ:</strong></p>
                            <ul>
                                <li>オス画像: <span id="training-male-count">0</span>枚</li>
                                <li>メス画像: <span id="training-female-count">0</span>枚</li>
                                <li>アノテーション済み: <span id="training-annotated-count">0</span>枚</li>
                            </ul>
                        </div>
                        
                        <div id="training-progress-detail" class="mt-3">
                            <div class="progress mb-2">
                                <div id="training-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     style="width: 0%">0%</div>
                            </div>
                            <small id="training-status-text" class="text-muted">待機中...</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-info-circle me-2"></i>学習の流れ</h6>
                    </div>
                    <div class="card-body">
                        <div id="training-steps">
                            <div class="training-step" id="step-feature-extraction">
                                <i class="fas fa-circle-notch text-muted me-2"></i>
                                <span>特徴量抽出</span>
                            </div>
                            <div class="training-step" id="step-model-training">
                                <i class="fas fa-circle-notch text-muted me-2"></i>
                                <span>モデル訓練</span>
                            </div>
                            <div class="training-step" id="step-basic-evaluation">
                                <i class="fas fa-circle-notch text-muted me-2"></i>
                                <span>基本評価</span>
                            </div>
                            <div class="training-step" id="step-detailed-analysis">
                                <i class="fas fa-circle-notch text-muted me-2"></i>
                                <span>詳細分析</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- YOLOトレーニングセクション -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog me-2"></i>YOLOトレーニング設定</h5>
                    </div>
                    <div class="card-body">
                        <form id="yolo-training-form">
                            <div class="mb-3">
                                <label for="yolo-weights" class="form-label">初期重み</label>
                                <select class="form-select" id="yolo-weights" name="weights">
                                    <option value="yolov5s.pt" selected>YOLOv5s (小)</option>
                                    <option value="yolov5m.pt">YOLOv5m (中)</option>
                                    <option value="yolov5l.pt">YOLOv5l (大)</option>
                                    <option value="yolov5n.pt">YOLOv5n (極小)</option>
                                </select>
                                <div class="form-text">モデルサイズと精度のバランスを選択します。</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="yolo-batch-size" class="form-label">バッチサイズ</label>
                                <input type="number" class="form-control" id="yolo-batch-size" name="batch_size" value="16" min="1" max="64">
                                <div class="form-text">大きいほど学習が速くなりますが、メモリ消費が増えます。</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="yolo-epochs" class="form-label">エポック数</label>
                                <input type="number" class="form-control" id="yolo-epochs" name="epochs" value="100" min="1" max="1000">
                                <div class="form-text">多いほど精度が向上しますが、時間がかかります。</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="yolo-img-size" class="form-label">画像サイズ</label>
                                <select class="form-select" id="yolo-img-size" name="img_size">
                                    <option value="416">416x416</option>
                                    <option value="512">512x512</option>
                                    <option value="640" selected>640x640</option>
                                    <option value="1280">1280x1280</option>
                                </select>
                                <div class="form-text">大きいほど精度が向上しますが、学習に時間がかかります。</div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="button" id="start-yolo-training-btn" class="btn btn-primary">
                                    <i class="fas fa-play me-1"></i> YOLOトレーニング開始
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-chart-line me-2"></i>トレーニング進捗</h5>
                        <button type="button" id="stop-yolo-training-btn" class="btn btn-sm btn-danger">
                            <i class="fas fa-stop me-1"></i> 停止
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="yolo-training-status" class="alert alert-secondary">
                            トレーニングはまだ開始されていません
                        </div>
                        
                        <div id="yolo-progress-container" class="mb-3" style="display: none;">
                            <div class="progress mb-2">
                                <div id="yolo-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                    role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <small id="yolo-status-text" class="text-muted">準備中...</small>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-1">
                                    <strong>経過時間:</strong> <span id="yolo-elapsed-time">-</span>
                                </div>
                                <div class="mb-1">
                                    <strong>現在のエポック:</strong> <span id="yolo-current-epoch">-</span> / <span id="yolo-total-epochs">-</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-1">
                                    <strong>Box Loss:</strong> <span id="yolo-box-loss">-</span>
                                </div>
                                <div class="mb-1">
                                    <strong>Obj Loss:</strong> <span id="yolo-obj-loss">-</span>
                                </div>
                                <div class="mb-1">
                                    <strong>mAP50:</strong> <span id="yolo-map50">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="yolo-training-images" class="mt-3">
                            <!-- トレーニング画像がここに表示されます -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- フェーズ3: 結果分析セクション（非表示状態で開始） -->
    <div id="analysis-section" class="phase-section d-none">
        <div class="row">
            <!-- 統合結果サマリー -->
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-trophy me-2"></i>学習結果サマリー</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="metric-card bg-primary text-white">
                                    <div class="metric-value" id="final-accuracy">0%</div>
                                    <div class="metric-label">総合精度</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card bg-info text-white">
                                    <div class="metric-value" id="final-precision">0%</div>
                                    <div class="metric-label">適合率</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card bg-success text-white">
                                    <div class="metric-value" id="final-recall">0%</div>
                                    <div class="metric-label">再現率</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card bg-warning text-white">
                                    <div class="metric-value" id="annotation-count">
                                        ♂:<span id="male-annotation-count">0</span> ♀:<span id="female-annotation-count">0</span>
                                    </div>
                                    <div class="metric-label">
                                        アノテーション枚数
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 詳細結果 -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-chart-line me-2"></i>詳細分析結果</h6>
                    </div>
                    <div class="card-body">
                        <div id="unified-results-content">
                            <!-- 評価グラフがここに動的に挿入される -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 改善提案 -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-lightbulb me-2"></i>改善提案</h6>
                    </div>
                    <div class="card-body">
                        <div id="improvement-suggestions">
                            <!-- 改善提案がここに動的に挿入される -->
                        </div>
                        
                        <div class="mt-3">
                            <button id="start-new-iteration-btn" class="btn btn-primary w-100">
                                <i class="fas fa-redo me-1"></i>新しい学習を開始
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 学習履歴 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>学習履歴
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="unified-learning-history">
                    <!-- ここに統合された履歴が表示されます -->
                    <div class="text-center p-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">読み込み中...</span>
                        </div>
                        <p class="mt-2">履歴を読み込んでいます...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 結果プレースホルダー（初期表示） -->
    <div id="results-placeholder" class="text-center py-5">
        <i class="fas fa-rocket fa-3x mb-3 text-muted"></i>
        <h5 class="text-muted">統合学習システム</h5>
        <p class="text-muted">データをアップロードして学習を開始しましょう</p>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- アノテーションモーダルはannotation_tools.jsから動的生成 -->
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script type="module" src="{{ url_for('static', filename='js/learning/index.js') }}"></script>
{% endblock %}