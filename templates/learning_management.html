{% extends "base.html" %}

{% block title %}YOLO学習システム - ウニ生殖乳頭分析{% endblock %}

{% block extra_css %}
<style>
    .annotation-canvas {
        max-width: 100%;
        border: 2px solid #dee2e6;
        cursor: crosshair;
    }
    
    .image-preview-container {
        position: relative;
        display: inline-block;
        margin: 10px;
    }
    
    .gender-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        z-index: 10;
    }
    
    .annotation-status {
        position: absolute;
        bottom: 5px;
        left: 5px;
        font-size: 0.8rem;
    }
    
    .workflow-step {
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        background: #f8f9fa;
        border: 2px solid transparent;
        transition: all 0.3s;
    }
    
    .workflow-step.active {
        border-color: #007bff;
        background: #e7f3ff;
    }
    
    .workflow-step.completed {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #6c757d;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        margin-right: 15px;
    }
    
    .workflow-step.active .step-number {
        background: #007bff;
    }
    
    .workflow-step.completed .step-number {
        background: #28a745;
    }
    
    .annotation-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    
    .class-selector {
        margin-bottom: 10px;
    }
    
    .class-btn {
        width: 100%;
        margin: 5px 0;
    }
    
    .training-metric {
        text-align: center;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        margin: 5px;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="text-center mb-4">
        <i class="fas fa-robot"></i> YOLO学習システム
    </h2>
    
    <!-- ワークフロー -->
    <div class="row mb-4">
        <div class="col-12">
            <!-- ステップ1: 画像アップロード -->
            <div class="workflow-step active" id="step-1">
                <div class="d-flex align-items-center">
                    <div class="step-number">1</div>
                    <div class="flex-grow-1">
                        <h4>画像アップロード</h4>
                        <p class="mb-2">ウニの生殖乳頭画像をアップロードしてください（複数選択可能）</p>
                        
                        <form id="imageUploadForm" class="d-flex gap-3 align-items-end">
                            <div class="flex-grow-1">
                                <input type="file" class="form-control" id="imageFiles" 
                                       accept="image/*" multiple required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload"></i> アップロード
                            </button>
                        </form>
                        
                        <div class="mt-3">
                            <span class="badge bg-secondary">アップロード済み: <span id="uploadedCount">0</span>枚</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ステップ2: アノテーション -->
            <div class="workflow-step" id="step-2">
                <div class="d-flex align-items-center">
                    <div class="step-number">2</div>
                    <div class="flex-grow-1">
                        <h4>バウンディングボックスでアノテーション</h4>
                        <p class="mb-2">各画像の生殖乳頭を囲んで、雄・雌を指定してください</p>
                        
                        <div id="annotationProgress" class="d-none">
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%">
                                    <span class="progress-text">0/0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div id="imageList" class="d-flex flex-wrap"></div>
                        
                        <!-- アノテーションエリア -->
                        <div id="annotationArea" class="d-none">
                            <div class="row">
                                <div class="col-md-8">
                                    <canvas id="annotationCanvas" class="annotation-canvas"></canvas>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5>アノテーション設定</h5>
                                            <div class="mb-3">
                                                <label class="form-label">現在の画像</label>
                                                <p id="currentImageName" class="text-muted">-</p>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">クラス選択</label>
                                                <div class="btn-group-vertical w-100" role="group">
                                                    <input type="radio" class="btn-check" name="classType" 
                                                           id="class-male" value="male" checked>
                                                    <label class="btn btn-outline-primary" for="class-male">
                                                        <i class="fas fa-mars"></i> 生殖乳頭（雄）
                                                    </label>
                                                    
                                                    <input type="radio" class="btn-check" name="classType" 
                                                           id="class-female" value="female">
                                                    <label class="btn btn-outline-danger" for="class-female">
                                                        <i class="fas fa-venus"></i> 生殖乳頭（雌）
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">アノテーション数</label>
                                                <div id="annotationStats">
                                                    <div>雄: <span id="maleAnnotations">0</span>個</div>
                                                    <div>雌: <span id="femaleAnnotations">0</span>個</div>
                                                </div>
                                            </div>
                                            
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-warning" id="clearAnnotations">
                                                    <i class="fas fa-eraser"></i> クリア
                                                </button>
                                                <button class="btn btn-success" id="saveAnnotations">
                                                    <i class="fas fa-save"></i> 保存して次へ
                                                </button>
                                                <button class="btn btn-secondary" id="skipImage">
                                                    <i class="fas fa-forward"></i> スキップ
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ステップ3: YOLO学習 -->
            <div class="workflow-step" id="step-3">
                <div class="d-flex align-items-center">
                    <div class="step-number">3</div>
                    <div class="flex-grow-1">
                        <h4>YOLO学習実行</h4>
                        <p class="mb-2">アノテーションデータを使用してYOLOモデルを学習します</p>
                        
                        <div id="trainingConfig" class="row mb-3 d-none">
                            <div class="col-md-3">
                                <label class="form-label">エポック数</label>
                                <input type="number" class="form-control" id="epochs" value="100" min="10" max="1000">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">バッチサイズ</label>
                                <select class="form-select" id="batchSize">
                                    <option value="8">8</option>
                                    <option value="16" selected>16</option>
                                    <option value="32">32</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">モデルサイズ</label>
                                <select class="form-select" id="modelSize">
                                    <option value="yolov5n.pt">Nano (最速)</option>
                                    <option value="yolov5s.pt" selected>Small (バランス)</option>
                                    <option value="yolov5m.pt">Medium (高精度)</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button class="btn btn-success w-100" id="startTraining">
                                    <i class="fas fa-play"></i> 学習開始
                                </button>
                            </div>
                        </div>
                        
                        <div id="trainingProgress" class="d-none">
                            <div class="progress mb-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%">0%</div>
                            </div>
                            <div class="text-center">
                                <p id="trainingStatus">準備中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ステップ4: 学習結果 -->
            <div class="workflow-step" id="step-4">
                <div class="d-flex align-items-center">
                    <div class="step-number">4</div>
                    <div class="flex-grow-1">
                        <h4>学習結果・精度確認</h4>
                        <p class="mb-2">学習の成果と現在のモデル精度を確認できます</p>
                        
                        <div id="trainingResults" class="d-none">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="training-metric">
                                        <div class="metric-value" id="accuracy">-</div>
                                        <div class="metric-label">精度</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="training-metric">
                                        <div class="metric-value" id="mAP">-</div>
                                        <div class="metric-label">mAP</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="training-metric">
                                        <div class="metric-value" id="totalImages">-</div>
                                        <div class="metric-label">学習画像数</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="training-metric">
                                        <div class="metric-value" id="trainingTime">-</div>
                                        <div class="metric-label">学習時間</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3 text-center">
                                <button class="btn btn-primary" id="downloadModel">
                                    <i class="fas fa-download"></i> モデルをダウンロード
                                </button>
                                <button class="btn btn-secondary" id="newTraining">
                                    <i class="fas fa-redo"></i> 新しい学習を開始
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- アノテーション操作ガイド -->
<div class="annotation-controls d-none" id="annotationControls">
    <h6>操作方法</h6>
    <small>
        <div><i class="fas fa-mouse"></i> マウスドラッグで囲む</div>
        <div><i class="fas fa-keyboard"></i> Delete: 選択削除</div>
        <div><i class="fas fa-undo"></i> Ctrl+Z: 元に戻す</div>
    </small>
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
// 新しいワークフロー用のJavaScriptを追加
import { YoloAnnotator } from '/static/js/learning/YoloAnnotator.js';

// ここに新しいワークフロー制御のJavaScriptを実装
</script>
{% endblock %}