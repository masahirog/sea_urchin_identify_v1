{% extends "base.html" %}

{% block title %}モデル評価ダッシュボード - ウニ生殖乳頭分析システム{% endblock %}

{% block description %}ウニ生殖乳頭分析システムのモデル評価ダッシュボード - モデル精度やアノテーション影響の分析{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/model_evaluation.css') }}">
{% endblock %}

{% block content %}
<!-- メインタブナビゲーション -->
<ul class="nav nav-tabs" id="evaluationTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="evaluation-tab" data-bs-toggle="tab" data-bs-target="#evaluation" 
                type="button" role="tab" aria-controls="evaluation" aria-selected="true">
            <i class="fas fa-chart-line" aria-hidden="true"></i> モデル評価
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="annotation-tab" data-bs-toggle="tab" data-bs-target="#annotation" 
                type="button" role="tab" aria-controls="annotation" aria-selected="false">
            <i class="fas fa-tags" aria-hidden="true"></i> アノテーション分析
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" 
                type="button" role="tab" aria-controls="history" aria-selected="false">
            <i class="fas fa-history" aria-hidden="true"></i> 評価履歴
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" 
                type="button" role="tab" aria-controls="settings" aria-selected="false">
            <i class="fas fa-cog" aria-hidden="true"></i> 設定
        </button>
    </li>
</ul>

<div class="tab-content" id="evaluationTabContent">
    <!-- モデル評価タブ -->
    <div class="tab-pane fade show active" id="evaluation" role="tabpanel" aria-labelledby="evaluation-tab">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-play" aria-hidden="true"></i> 評価実行</h5>
                    </div>
                    <div class="card-body">
                        <button id="run-evaluation-btn" class="btn btn-primary mb-3 w-100">
                            <i class="fas fa-play" aria-hidden="true"></i> 新しいモデル評価を実行
                        </button>
                        <p class="small text-muted">現在のデータセットとモデルを使用して包括的な評価を実行します。</p>
                        
                        <div id="evaluationStatus" class="alert alert-info d-none" role="alert">
                            処理を開始してください
                        </div>
                        <div class="progress mb-3 d-none" id="evaluationProgressContainer">
                            <div id="evaluationProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line" aria-hidden="true"></i> モデル評価結果</h5>
                    </div>
                    <div class="card-body">
                        <div id="evaluationPlaceholder" class="text-center py-5">
                            <i class="fas fa-chart-bar fa-3x mb-3 text-muted" aria-hidden="true"></i>
                            <p class="text-muted">評価を実行するか、履歴から結果を選択してください</p>
                        </div>
                        
                        <div id="evaluationResult" class="d-none">
                            <!-- メトリクス概要 -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="metric-card bg-light">
                                        <div class="metric-value" id="accuracyValue">0%</div>
                                        <div class="metric-label">精度 (Accuracy)</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-card bg-light">
                                        <div class="metric-value" id="precisionValue">0%</div>
                                        <div class="metric-label">適合率 (Precision)</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-card bg-light">
                                        <div class="metric-value" id="recallValue">0%</div>
                                        <div class="metric-label">再現率 (Recall)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- グラフ -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>学習曲線</h6>
                                    <div id="learningCurveContainer" class="mb-3">
                                        <img id="learningCurveImg" class="evaluation-img" src="" alt="学習曲線">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>混同行列</h6>
                                    <div id="confusionMatrixContainer" class="mb-3">
                                        <img id="confusionMatrixImg" class="evaluation-img" src="" alt="混同行列">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ROCカーブとクロスバリデーション -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>ROCカーブ</h6>
                                    <div id="rocCurveContainer" class="mb-3">
                                        <img id="rocCurveImg" class="evaluation-img" src="" alt="ROCカーブ">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>クロスバリデーションスコア</h6>
                                    <div id="cvScoresContainer" class="mb-3">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">分割</th>
                                                        <th scope="col">精度</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="cvScoresTableBody">
                                                    <!-- クロスバリデーションスコアがここに表示されます -->
                                                </tbody>
                                                <tfoot>
                                                    <tr class="table-secondary">
                                                        <th scope="row">平均</th>
                                                        <td id="cvMeanValue">-</td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row">標準偏差</th>
                                                        <td id="cvStdValue">-</td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 詳細レポート -->
                            <div class="row">
                                <div class="col-12">
                                    <h6>詳細レポート</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th scope="col">クラス</th>
                                                    <th scope="col">適合率</th>
                                                    <th scope="col">再現率</th>
                                                    <th scope="col">F1スコア</th>
                                                    <th scope="col">サポート</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <th scope="row">オス (male)</th>
                                                    <td id="malePrecision">-</td>
                                                    <td id="maleRecall">-</td>
                                                    <td id="maleF1">-</td>
                                                    <td id="maleSupport">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">メス (female)</th>
                                                    <td id="femalePrecision">-</td>
                                                    <td id="femaleRecall">-</td>
                                                    <td id="femaleF1">-</td>
                                                    <td id="femaleSupport">-</td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr class="table-secondary">
                                                    <th scope="row">平均/合計</th>
                                                    <td id="avgPrecision">-</td>
                                                    <td id="avgRecall">-</td>
                                                    <td id="avgF1">-</td>
                                                    <td id="totalSupport">-</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- アノテーション分析タブ -->
    <div class="tab-pane fade" id="annotation" role="tabpanel" aria-labelledby="annotation-tab">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-search" aria-hidden="true"></i> 分析実行</h5>
                    </div>
                    <div class="card-body">
                        <button id="analyze-annotations-btn" class="btn btn-success mb-3 w-100">
                            <i class="fas fa-search" aria-hidden="true"></i> アノテーション影響分析を実行
                        </button>
                        <p class="small text-muted">アノテーションデータがモデルの学習・精度に与える影響を分析します。</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-tags" aria-hidden="true"></i> アノテーション影響分析</h5>
                    </div>
                    <div class="card-body">
                        <div id="annotationPlaceholder" class="text-center py-5">
                            <i class="fas fa-tag fa-3x mb-3 text-muted" aria-hidden="true"></i>
                            <p class="text-muted">アノテーション影響分析を実行してください</p>
                        </div>
                        
                        <div id="annotationResult" class="d-none">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div id="annotationChartContainer" class="mb-3">
                                        <img id="annotationImpactImg" class="evaluation-img" src="" alt="アノテーション影響">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>アノテーション状況</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <th scope="row">オス画像数</th>
                                                    <td id="maleTotalCount">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">アノテーション済みオス画像数</th>
                                                    <td id="maleAnnotatedCount">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">メス画像数</th>
                                                    <td id="femaleTotalCount">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">アノテーション済みメス画像数</th>
                                                    <td id="femaleAnnotatedCount">-</td>
                                                </tr>
                                                <tr class="table-secondary">
                                                    <th scope="row">アノテーション率</th>
                                                    <td id="annotationRate">-</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                                <span id="annotationInsight">アノテーションデータが学習に影響を与えています。</span>
                            </div>
                            
                            <div class="text-center">
                                <a href="{{ url_for('sample.analyze_samples_page') }}" class="btn btn-primary">
                                    <i class="fas fa-pen" aria-hidden="true"></i> サンプルアノテーションページへ
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 評価履歴タブ -->
    <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history" aria-hidden="true"></i> 評価履歴</h5>
            </div>
            <div class="card-body p-0">
                <div id="historyList" class="list-group list-group-flush">
                    <!-- ここに履歴項目が表示されます -->
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">履歴を読み込んでいます...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 設定タブ -->
    <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog" aria-hidden="true"></i> システム設定</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">システムの各種設定を行えます。</p>
                        <p class="text-muted">現在利用可能な設定はありません。</p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> 高度な操作</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning small">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            注意: この操作はすべてのアノテーションデータを削除します。
                        </div>
                        <div class="mb-3">
                            <label for="resetConfirmation" class="form-label small">確認のため、「DELETE ANNOTATION」と入力してください：</label>
                            <input type="text" class="form-control form-control-sm" id="resetConfirmation" placeholder="DELETE ANNOTATION">
                        </div>
                        <button id="resetAnnotationsBtn" class="btn btn-outline-danger btn-sm w-100">
                            <i class="fas fa-trash" aria-hidden="true"></i> アノテーションデータをリセット
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js for annotations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<!-- Evaluation scripts -->
<script src="{{ url_for('static', filename='js/evaluation/evaluation-utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/evaluation/evaluation-history.js') }}"></script>
<script src="{{ url_for('static', filename='js/evaluation/annotation-analysis.js') }}"></script>
<script src="{{ url_for('static', filename='js/evaluation/evaluation-core.js') }}"></script>

<script>
// 評価実行ボタンのイベントリスナー追加
document.addEventListener('DOMContentLoaded', function() {
    const runEvaluationBtn = document.getElementById('run-evaluation-btn');
    if (runEvaluationBtn && typeof runModelEvaluation === 'function') {
        runEvaluationBtn.addEventListener('click', runModelEvaluation);
    } else {
        console.error('評価実行ボタンまたは関数が見つかりません');
    }
});

// evalution_runner初期化関数
function initEvaluationRunner() {
    console.log('評価実行モジュールの初期化開始');
    
    const runEvaluationBtn = document.getElementById('run-evaluation-btn');
    if (runEvaluationBtn) {
        console.log('評価実行ボタンが見つかりました');
        runEvaluationBtn.addEventListener('click', function() {
            console.log('評価実行ボタンがクリックされました');
            runModelEvaluation();
        });
    } else {
        console.error('評価実行ボタンが見つかりません: run-evaluation-btn');
    }
    
    console.log('評価実行モジュールの初期化完了');
}

// モデル評価の実行
function runModelEvaluation() {
    console.log('モデル評価の実行開始');
    
    showLoading();
    
    updateEvaluationStatus('evaluationStatus', 'alert-info', 'モデル評価を準備中...');
    showProgressBar('evaluationProgressContainer', 'evaluationProgressBar', 0);
    
    console.log('モデル評価リクエスト送信');
    
    fetch('/evaluation/run_evaluation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('モデル評価レスポンス:', response.status, response.ok);
        if (!response.ok) {
            throw new Error(`サーバーエラー: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('モデル評価データ:', data);
        hideLoading();
        
        if (data.error) {
            console.error('サーバーエラー:', data.error);
            updateEvaluationStatus('evaluationStatus', 'alert-danger', 'エラー: ' + data.error);
            showErrorMessage('エラー: ' + data.error);
            return;
        }
        
        if (window.modelEvaluation) {
            window.modelEvaluation.currentTaskId = data.task_id;
            console.log('タスクID保存:', window.modelEvaluation.currentTaskId);
        }
        
        updateEvaluationStatus('evaluationStatus', 'alert-info', 'モデル評価を開始しました...');
        updateProgressBar('evaluationProgressBar', 10);
        
        console.log('状態チェック開始');
        if (typeof startStatusCheck === 'function') {
            startStatusCheck();
        }
        
        showSuccessMessage('モデル評価を開始しました。完了までお待ちください。');
    })
    .catch(error => {
        console.error('モデル評価実行エラー:', error);
        hideLoading();
        updateEvaluationStatus('evaluationStatus', 'alert-danger', 'エラー: ' + error.message);
        showErrorMessage('モデル評価実行中にエラーが発生しました: ' + error.message);
    });
}
</script>
{% endblock %}