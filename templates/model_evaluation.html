<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ウニ生殖乳頭分析システムのモデル評価ダッシュボード - モデル精度やアノテーション影響の分析">
    <title>モデル評価ダッシュボード</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/model_evaluation.css') }}">
</head>
<body>
    <div class="container mt-3 mb-5">
        <h1 class="text-center mb-4">モデル評価ダッシュボード</h1>
        
        <div class="mb-3">
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left" aria-hidden="true"></i> メインページに戻る
            </a>
        </div>
        
        <!-- 操作パネル -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-cogs" aria-hidden="true"></i> モデル評価操作</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button id="run-evaluation-btn" class="btn btn-primary mb-3 w-100">
                            <i class="fas fa-play" aria-hidden="true"></i> 新しいモデル評価を実行
                        </button>
                        <p class="small text-muted">現在のデータセットとモデルを使用して包括的な評価を実行します。</p>
                    </div>
                    <div class="col-md-6">
                        <button id="analyze-annotations-btn" class="btn btn-success mb-3 w-100">
                            <i class="fas fa-search" aria-hidden="true"></i> アノテーション影響分析を実行
                        </button>
                        <p class="small text-muted">アノテーションデータがモデルの学習・精度に与える影響を分析します。</p>
                    </div>
                </div>
                <div id="evaluation-status" class="alert alert-info d-none" role="alert">
                    処理を開始してください
                </div>
                <div class="progress mb-3 d-none" id="evaluation-progress-container">
                    <div id="evaluation-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- 左側のメイン評価パネル -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line" aria-hidden="true"></i> モデル評価結果</h5>
                    </div>
                    <div class="card-body">
                        <div id="evaluation-placeholder" class="text-center py-5">
                            <i class="fas fa-chart-bar fa-3x mb-3 text-muted" aria-hidden="true"></i>
                            <p class="text-muted">評価を実行するか、履歴から結果を選択してください</p>
                        </div>
                        
                        <div id="evaluation-result" class="d-none">
                            <!-- メトリクス概要 -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="metric-card bg-light">
                                        <div class="metric-value" id="accuracy-value">0%</div>
                                        <div class="metric-label">精度 (Accuracy)</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-card bg-light">
                                        <div class="metric-value" id="precision-value">0%</div>
                                        <div class="metric-label">適合率 (Precision)</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-card bg-light">
                                        <div class="metric-value" id="recall-value">0%</div>
                                        <div class="metric-label">再現率 (Recall)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- グラフ -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>学習曲線</h6>
                                    <div id="learning-curve-container" class="mb-3">
                                        <img id="learning-curve-img" class="evaluation-img" src="" alt="学習曲線">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>混同行列</h6>
                                    <div id="confusion-matrix-container" class="mb-3">
                                        <img id="confusion-matrix-img" class="evaluation-img" src="" alt="混同行列">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ROCカーブ -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>ROCカーブ</h6>
                                    <div id="roc-curve-container" class="mb-3">
                                        <img id="roc-curve-img" class="evaluation-img" src="" alt="ROCカーブ">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>クロスバリデーションスコア</h6>
                                    <div id="cv-scores-container" class="mb-3">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">分割</th>
                                                        <th scope="col">精度</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="cv-scores-table-body">
                                                    <!-- クロスバリデーションスコアがここに表示されます -->
                                                </tbody>
                                                <tfoot>
                                                    <tr class="table-secondary">
                                                        <th scope="row">平均</th>
                                                        <td id="cv-mean-value">-</td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row">標準偏差</th>
                                                        <td id="cv-std-value">-</td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 詳細レポート -->
                            <div class="row">
                                <div class="col-12">
                                    <h6>詳細レポート</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th scope="col">クラス</th>
                                                    <th scope="col">適合率</th>
                                                    <th scope="col">再現率</th>
                                                    <th scope="col">F1スコア</th>
                                                    <th scope="col">サポート</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <th scope="row">オス (male)</th>
                                                    <td id="male-precision">-</td>
                                                    <td id="male-recall">-</td>
                                                    <td id="male-f1">-</td>
                                                    <td id="male-support">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">メス (female)</th>
                                                    <td id="female-precision">-</td>
                                                    <td id="female-recall">-</td>
                                                    <td id="female-f1">-</td>
                                                    <td id="female-support">-</td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr class="table-secondary">
                                                    <th scope="row">平均/合計</th>
                                                    <td id="avg-precision">-</td>
                                                    <td id="avg-recall">-</td>
                                                    <td id="avg-f1">-</td>
                                                    <td id="total-support">-</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- アノテーション影響分析 -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-tags" aria-hidden="true"></i> アノテーション影響分析</h5>
                    </div>
                    <div class="card-body">
                        <div id="annotation-placeholder" class="text-center py-5">
                            <i class="fas fa-tag fa-3x mb-3 text-muted" aria-hidden="true"></i>
                            <p class="text-muted">アノテーション影響分析を実行してください</p>
                        </div>
                        
                        <div id="annotation-result" class="d-none">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div id="annotation-chart-container" class="mb-3">
                                        <img id="annotation-impact-img" class="evaluation-img" src="" alt="アノテーション影響">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>アノテーション状況</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <th scope="row">オス画像数</th>
                                                    <td id="male-total-count">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">アノテーション済みオス画像数</th>
                                                    <td id="male-annotated-count">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">メス画像数</th>
                                                    <td id="female-total-count">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">アノテーション済みメス画像数</th>
                                                    <td id="female-annotated-count">-</td>
                                                </tr>
                                                <tr class="table-secondary">
                                                    <th scope="row">アノテーション率</th>
                                                    <td id="annotation-rate">-</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                                <span id="annotation-insight">アノテーションデータが学習に影響を与えています。</span>
                            </div>
                            
                            <div class="text-center">
                                <a href="{{ url_for('sample.analyze_samples_page') }}" class="btn btn-primary">
                                    <i class="fas fa-pen" aria-hidden="true"></i> サンプルアノテーションページへ
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右側の履歴パネル -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history" aria-hidden="true"></i> 評価履歴</h5>
                    </div>
                    <div class="card-body">
                        <div id="history-list" class="list-group" role="list" aria-label="評価履歴リスト">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">読み込み中...</span>
                                </div>
                                <p class="mt-2 text-muted">履歴を読み込んでいます...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ローディングオーバーレイ -->
    <div id="loading-overlay" class="d-none" aria-live="polite">
        <div class="spinner-border text-light me-3" role="status">
            <span class="visually-hidden">処理中...</span>
        </div>
        処理中...
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="{{ url_for('static', filename='js/utilities.js') }}"></script>
    <script src="{{ url_for('static', filename='js/model_evaluation.js') }}"></script>
</body>
</html>