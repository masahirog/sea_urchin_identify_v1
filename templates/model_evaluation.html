<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ウニ生殖乳頭分析システムのモデル評価ダッシュボード - モデル精度やアノテーション影響の分析">
    <title>モデル評価ダッシュボード</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/model_evaluation.css') }}">
</head>
<body>
    <div class="container mt-3 mb-5">
        <h1 class="text-center mb-4">モデル評価ダッシュボード</h1>
        
        <div class="mb-3">
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left" aria-hidden="true"></i> メインページに戻る
            </a>
        </div>
        
        <!-- 操作パネル -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-cogs" aria-hidden="true"></i> モデル評価操作</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <button id="run-evaluation-btn" class="btn btn-primary mb-3 w-100">
                            <i class="fas fa-play" aria-hidden="true"></i> 新しいモデル評価を実行
                        </button>
                        <p class="small text-muted">現在のデータセットとモデルを使用して包括的な評価を実行します。</p>
                    </div>
                    <div class="col-md-6">
                        <button id="analyze-annotations-btn" class="btn btn-success mb-3 w-100">
                            <i class="fas fa-search" aria-hidden="true"></i> アノテーション影響分析を実行
                        </button>
                        <p class="small text-muted">アノテーションデータがモデルの学習・精度に与える影響を分析します。</p>
                    </div>
                </div>
                <div id="evaluationStatus" class="alert alert-info d-none" role="alert">
                    処理を開始してください
                </div>
                <div class="progress mb-3 d-none" id="evaluationProgressContainer">
                    <div id="evaluationProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- 左側のメイン評価パネル -->
            <div class="col-md-8">
                <!-- 元のHTMLを保持 -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line" aria-hidden="true"></i> モデル評価結果</h5>
                    </div>
                    <div class="card-body">
                        <!-- ここに追加 -->
                        <div id="evaluationPlaceholder" class="text-center py-5">
                            <i class="fas fa-chart-bar fa-3x mb-3 text-muted" aria-hidden="true"></i>
                            <p class="text-muted">評価を実行するか、履歴から結果を選択してください</p>
                        </div>
                        
                        <div id="evaluationResult" class="d-none">
                            <!-- メトリクス概要 -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="metric-card bg-light">
                                        <div class="metric-value" id="accuracyValue">0%</div>
                                        <div class="metric-label">精度 (Accuracy)</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-card bg-light">
                                        <div class="metric-value" id="precisionValue">0%</div>
                                        <div class="metric-label">適合率 (Precision)</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="metric-card bg-light">
                                        <div class="metric-value" id="recallValue">0%</div>
                                        <div class="metric-label">再現率 (Recall)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- グラフ -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>学習曲線</h6>
                                    <div id="learningCurveContainer" class="mb-3">
                                        <img id="learningCurveImg" class="evaluation-img" src="" alt="学習曲線">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>混同行列</h6>
                                    <div id="confusionMatrixContainer" class="mb-3">
                                        <img id="confusionMatrixImg" class="evaluation-img" src="" alt="混同行列">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ROCカーブ -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <h6>ROCカーブ</h6>
                                    <div id="rocCurveContainer" class="mb-3">
                                        <img id="rocCurveImg" class="evaluation-img" src="" alt="ROCカーブ">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>クロスバリデーションスコア</h6>
                                    <div id="cvScoresContainer" class="mb-3">
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th scope="col">分割</th>
                                                        <th scope="col">精度</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="cvScoresTableBody">
                                                    <!-- クロスバリデーションスコアがここに表示されます -->
                                                </tbody>
                                                <tfoot>
                                                    <tr class="table-secondary">
                                                        <th scope="row">平均</th>
                                                        <td id="cvMeanValue">-</td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row">標準偏差</th>
                                                        <td id="cvStdValue">-</td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 詳細レポート -->
                            <div class="row">
                                <div class="col-12">
                                    <h6>詳細レポート</h6>
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th scope="col">クラス</th>
                                                    <th scope="col">適合率</th>
                                                    <th scope="col">再現率</th>
                                                    <th scope="col">F1スコア</th>
                                                    <th scope="col">サポート</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <th scope="row">オス (male)</th>
                                                    <td id="malePrecision">-</td>
                                                    <td id="maleRecall">-</td>
                                                    <td id="maleF1">-</td>
                                                    <td id="maleSupport">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">メス (female)</th>
                                                    <td id="femalePrecision">-</td>
                                                    <td id="femaleRecall">-</td>
                                                    <td id="femaleF1">-</td>
                                                    <td id="femaleSupport">-</td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr class="table-secondary">
                                                    <th scope="row">平均/合計</th>
                                                    <td id="avgPrecision">-</td>
                                                    <td id="avgRecall">-</td>
                                                    <td id="avgF1">-</td>
                                                    <td id="totalSupport">-</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- アノテーション影響分析 -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-tags" aria-hidden="true"></i> アノテーション影響分析</h5>
                    </div>
                    <div class="card-body">
                        <div id="annotationPlaceholder" class="text-center py-5">
                            <i class="fas fa-tag fa-3x mb-3 text-muted" aria-hidden="true"></i>
                            <p class="text-muted">アノテーション影響分析を実行してください</p>
                        </div>
                        
                        <div id="annotationResult" class="d-none">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div id="annotationChartContainer" class="mb-3">
                                        <img id="annotationImpactImg" class="evaluation-img" src="" alt="アノテーション影響">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>アノテーション状況</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <th scope="row">オス画像数</th>
                                                    <td id="maleTotalCount">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">アノテーション済みオス画像数</th>
                                                    <td id="maleAnnotatedCount">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">メス画像数</th>
                                                    <td id="femaleTotalCount">-</td>
                                                </tr>
                                                <tr>
                                                    <th scope="row">アノテーション済みメス画像数</th>
                                                    <td id="femaleAnnotatedCount">-</td>
                                                </tr>
                                                <tr class="table-secondary">
                                                    <th scope="row">アノテーション率</th>
                                                    <td id="annotationRate">-</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
                                <span id="annotationInsight">アノテーションデータが学習に影響を与えています。</span>
                            </div>
                            
                            <div class="text-center">
                                <a href="/sample/analyze" class="btn btn-primary">
                                    <i class="fas fa-pen" aria-hidden="true"></i> サンプルアノテーションページへ
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右側の履歴パネル -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history" aria-hidden="true"></i> 評価履歴</h5>
                    </div>
                    <div class="card-body p-0">
                        <div id="historyList" class="list-group list-group-flush">
                            <!-- ここに履歴項目が表示されます -->
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">履歴を読み込んでいます...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> 危険な操作</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            警告: この操作はすべてのアノテーションデータを削除します。この操作は取り消せません。
                        </div>
                        <div class="mb-3">
                            <label for="resetConfirmation" class="form-label">確認のため、「DELETE ANNOTATION」と入力してください：</label>
                            <input type="text" class="form-control" id="resetConfirmation" placeholder="DELETE ANNOTATION">
                            <div class="form-text text-danger">大文字小文字も一致する必要があります</div>
                        </div>
                        <button id="resetAnnotationsBtn" class="btn btn-danger">
                            <i class="fas fa-trash" aria-hidden="true"></i> アノテーションデータをリセット
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ローディングオーバーレイ -->
    <div id="loadingOverlay" class="d-none" aria-live="polite">
        <div class="spinner-border text-light me-3" role="status">
            <span class="visually-hidden">処理中...</span>
        </div>
        処理中...
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="{{ url_for('static', filename='js/utilities.js') }}"></script>
    
    <!-- ★修正: JavaScriptファイルのパスを新しいディレクトリ構造に変更 -->
    <script src="{{ url_for('static', filename='js/evaluation/evaluation-utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/evaluation/evaluation-history.js') }}"></script>
    <script src="{{ url_for('static', filename='js/evaluation/annotation-analysis.js') }}"></script>
    <script src="{{ url_for('static', filename='js/evaluation/evaluation-core.js') }}"></script>
    
    <script>
    // 評価実行ボタンのイベントリスナー追加（コアファイル読み込み前にボタンが見つからない問題を解決）
    document.addEventListener('DOMContentLoaded', function() {
        // 評価実行ボタン
        const runEvaluationBtn = document.getElementById('run-evaluation-btn');
        if (runEvaluationBtn && typeof runModelEvaluation === 'function') {
            runEvaluationBtn.addEventListener('click', runModelEvaluation);
        } else {
            console.error('評価実行ボタンまたは関数が見つかりません');
        }
    });
    
    // evalution_runner初期化関数（evaluation-core.jsから移動）
    function initEvaluationRunner() {
        console.log('評価実行モジュールの初期化開始');
        
        const runEvaluationBtn = document.getElementById('run-evaluation-btn');
        if (runEvaluationBtn) {
            console.log('評価実行ボタンが見つかりました');
            runEvaluationBtn.addEventListener('click', function() {
                console.log('評価実行ボタンがクリックされました');
                runModelEvaluation();
            });
        } else {
            console.error('評価実行ボタンが見つかりません: run-evaluation-btn');
        }
        
        console.log('評価実行モジュールの初期化完了');
    }

    // モデル評価の実行
    function runModelEvaluation() {
        console.log('モデル評価の実行開始');
        
        // ローディング表示
        showLoading();
        
        // 「処理中」ステータスの表示
        updateEvaluationStatus('evaluationStatus', 'alert-info', 'モデル評価を準備中...');
        showProgressBar('evaluationProgressContainer', 'evaluationProgressBar', 0);
        
        console.log('モデル評価リクエスト送信');
        
        // リクエスト送信
        fetch('/evaluation/run_evaluation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('モデル評価レスポンス:', response.status, response.ok);
            if (!response.ok) {
                throw new Error(`サーバーエラー: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('モデル評価データ:', data);
            hideLoading();
            
            if (data.error) {
                console.error('サーバーエラー:', data.error);
                updateEvaluationStatus('evaluationStatus', 'alert-danger', 'エラー: ' + data.error);
                showErrorMessage('エラー: ' + data.error);
                return;
            }
            
            // タスクIDの保存
            if (window.modelEvaluation) {
                window.modelEvaluation.currentTaskId = data.task_id;
                console.log('タスクID保存:', window.modelEvaluation.currentTaskId);
            }
            
            // 状態表示の更新
            updateEvaluationStatus('evaluationStatus', 'alert-info', 'モデル評価を開始しました...');
            updateProgressBar('evaluationProgressBar', 10);
            
            // 状態チェックの開始
            console.log('状態チェック開始');
            if (typeof startStatusCheck === 'function') {
                startStatusCheck();
            }
            
            // 成功メッセージの表示
            showSuccessMessage('モデル評価を開始しました。完了までお待ちください。');
        })
        .catch(error => {
            console.error('モデル評価実行エラー:', error);
            hideLoading();
            updateEvaluationStatus('evaluationStatus', 'alert-danger', 'エラー: ' + error.message);
            showErrorMessage('モデル評価実行中にエラーが発生しました: ' + error.message);
        });
    }
    </script>
</body>
</html>