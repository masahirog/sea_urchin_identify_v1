{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h1>YOLO物体検出モデル管理</h1>
  
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>モデルトレーニング</h5>
        </div>
        <div class="card-body">
          <form id="training-form">
            <div class="mb-3">
              <label for="weights" class="form-label">初期重み</label>
              <select class="form-select" id="weights" name="weights">
                <option value="yolov5s.pt" selected>YOLOv5s (小)</option>
                <option value="yolov5m.pt">YOLOv5m (中)</option>
                <option value="yolov5l.pt">YOLOv5l (大)</option>
                <option value="yolov5n.pt">YOLOv5n (極小)</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="batch-size" class="form-label">バッチサイズ</label>
              <input type="number" class="form-control" id="batch-size" name="batch_size" value="4" min="1" max="64">
              <div class="form-text">メモリ容量に応じて調整してください。小さいほどメモリ消費が少なくなります。</div>
            </div>
            
            <div class="mb-3">
              <label for="epochs" class="form-label">エポック数</label>
              <input type="number" class="form-control" id="epochs" name="epochs" value="50" min="1" max="1000">
              <div class="form-text">トレーニングの繰り返し回数。多いほど精度が向上する可能性がありますが、時間がかかります。</div>
            </div>
            
            <div class="mb-3">
              <label for="img-size" class="form-label">画像サイズ</label>
              <select class="form-select" id="img-size" name="img_size">
                <option value="416">416x416</option>
                <option value="512">512x512</option>
                <option value="640" selected>640x640</option>
                <option value="1280">1280x1280</option>
              </select>
            </div>
            
            <div class="d-grid gap-2">
              <button type="button" id="start-training-btn" class="btn btn-primary">トレーニング開始</button>
              <button type="button" id="stop-training-btn" class="btn btn-danger">トレーニング停止</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5>トレーニング状況</h5>
        </div>
        <div class="card-body">
          <div id="training-status">
            <p>トレーニングはまだ開始されていません。</p>
          </div>
          
          <div class="progress mb-3" style="display: none;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
          </div>
          
          <div class="row mt-3">
            <div class="col-md-6">
              <div class="mb-2">
                <strong>経過時間:</strong> <span id="elapsed-time">-</span>
              </div>
              <div class="mb-2">
                <strong>現在のエポック:</strong> <span id="current-epoch">-</span> / <span id="total-epochs">-</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-2">
                <strong>Box Loss:</strong> <span id="box-loss">-</span>
              </div>
              <div class="mb-2">
                <strong>Obj Loss:</strong> <span id="obj-loss">-</span>
              </div>
              <div class="mb-2">
                <strong>mAP50:</strong> <span id="map50">-</span>
              </div>
            </div>
          </div>
          
          <div id="training-images" class="mt-4">
            <!-- トレーニング中の画像が表示されます -->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5>検出テスト</h5>
        </div>
        <div class="card-body">
          <form id="detection-form">
            <div class="mb-3">
              <label for="test-image" class="form-label">テスト画像</label>
              <input class="form-control" type="file" id="test-image" accept="image/*">
            </div>
            
            <div class="mb-3">
              <label for="confidence" class="form-label">信頼度閾値</label>
              <input type="range" class="form-range" id="confidence" min="0" max="1" step="0.05" value="0.25">
              <div class="text-center" id="confidence-value">0.25</div>
            </div>
            
            <div class="d-grid gap-2">
              <button type="button" id="detect-btn" class="btn btn-success">検出実行</button>
            </div>
          </form>
          
          <div class="mt-4" id="detection-results" style="display: none;">
            <h6>検出結果:</h6>
            <div class="row">
              <div class="col-md-6">
                <div id="result-image-container" class="text-center">
                  <!-- 結果画像が表示されます -->
                </div>
              </div>
              <div class="col-md-6">
                <div id="detection-details">
                  <!-- 検出詳細が表示されます -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row mt-4 mb-5">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5>画像管理とアノテーション</h5>
          <a href="/yolo/annotate" class="btn btn-primary">アノテーションツールを開く</a>
        </div>
        <div class="card-body">
          <p>生殖乳頭の検出精度を向上させるには、より多くの画像とアノテーションが必要です。</p>
          <p>アノテーションツールを使用して、画像内の生殖乳頭にバウンディングボックスを付けることができます。</p>
          
          <form id="upload-images-form" class="mt-3">
            <div class="mb-3">
              <label for="upload-images" class="form-label">画像をアップロード</label>
              <input class="form-control" type="file" id="upload-images" multiple accept="image/*">
            </div>
            
            <div class="d-grid gap-2">
              <button type="button" id="upload-btn" class="btn btn-primary">アップロード</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 信頼度スライダーの値を表示
    document.getElementById('confidence').addEventListener('input', function() {
      document.getElementById('confidence-value').textContent = this.value;
    });
    
    // トレーニング開始ボタン
    document.getElementById('start-training-btn').addEventListener('click', function() {
      const form = document.getElementById('training-form');
      const formData = new FormData(form);
      
      // FormDataをJSONに変換
      const jsonData = {};
      formData.forEach((value, key) => {
        jsonData[key] = value;
      });
      
      // トレーニング開始APIを呼び出し
      fetch('/yolo/training/start', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(jsonData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(data.message);
          // 状態更新を開始
          startStatusPolling();
        } else {
          alert('エラー: ' + data.message);
        }
      })
      .catch(error => {
        console.error('エラー:', error);
        alert('通信エラーが発生しました。');
      });
    });
    
    // トレーニング停止ボタン
    document.getElementById('stop-training-btn').addEventListener('click', function() {
      if (confirm('トレーニングを停止しますか？')) {
        fetch('/yolo/training/stop', {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
        })
        .catch(error => {
          console.error('エラー:', error);
          alert('通信エラーが発生しました。');
        });
      }
    });
    
    // 検出実行ボタン
    document.getElementById('detect-btn').addEventListener('click', function() {
      const fileInput = document.getElementById('test-image');
      if (fileInput.files.length === 0) {
        alert('画像を選択してください。');
        return;
      }
      
      const formData = new FormData();
      formData.append('image', fileInput.files[0]);
      formData.append('confidence', document.getElementById('confidence').value);
      
      fetch('/yolo/detect', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // 結果の表示
          showDetectionResults(data);
        } else {
          alert('エラー: ' + data.message);
        }
      })
      .catch(error => {
        console.error('エラー:', error);
        alert('通信エラーが発生しました。');
      });
    });
    
    // 画像アップロードボタン
    document.getElementById('upload-btn').addEventListener('click', function() {
      const fileInput = document.getElementById('upload-images');
      if (fileInput.files.length === 0) {
        alert('画像を選択してください。');
        return;
      }
      
      const formData = new FormData();
      for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('images[]', fileInput.files[i]);
      }
      
      fetch('/yolo/batch_detect', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(`${data.message}\nアップロードが完了しました。アノテーションツールで画像を編集できます。`);
        } else {
          alert('エラー: ' + data.message);
        }
      })
      .catch(error => {
        console.error('エラー:', error);
        alert('通信エラーが発生しました。');
      });
    });
    
    // トレーニング状態の定期的な更新
    let statusInterval = null;
    
    function startStatusPolling() {
      // 既存のポーリングを停止
      if (statusInterval) {
        clearInterval(statusInterval);
      }
      
      // 状態の初回取得
      updateTrainingStatus();
      
      // 5秒ごとに状態を更新
      statusInterval = setInterval(updateTrainingStatus, 5000);
    }
    
    function updateTrainingStatus() {
      fetch('/yolo/training/status')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'not_started') {
            document.getElementById('training-status').innerHTML = '<p>トレーニングはまだ開始されていません。</p>';
            document.querySelector('.progress').style.display = 'none';
          } else {
            // プログレスバーの更新
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.width = `${data.progress}%`;
            progressBar.textContent = `${Math.round(data.progress)}%`;
            document.querySelector('.progress').style.display = 'block';
            
            // ステータス情報の更新
            document.getElementById('elapsed-time').textContent = data.elapsed_time;
            document.getElementById('current-epoch').textContent = data.current_epoch;
            document.getElementById('total-epochs').textContent = data.total_epochs;
            
            // メトリクスの更新
            if (data.metrics) {
              const boxLoss = data.metrics.box_loss.length > 0 ? data.metrics.box_loss[data.metrics.box_loss.length - 1].toFixed(4) : '-';
              const objLoss = data.metrics.obj_loss.length > 0 ? data.metrics.obj_loss[data.metrics.obj_loss.length - 1].toFixed(4) : '-';
              const map50 = data.metrics.mAP50.length > 0 ? data.metrics.mAP50[data.metrics.mAP50.length - 1].toFixed(4) : '-';
              
              document.getElementById('box-loss').textContent = boxLoss;
              document.getElementById('obj-loss').textContent = objLoss;
              document.getElementById('map50').textContent = map50;
            }
            
            // 結果画像の表示
            if (data.result_images) {
              let imagesHtml = '';
              
              if (data.result_images.train_batch) {
                imagesHtml += `
                  <div class="mb-3">
                    <h6>トレーニングバッチ:</h6>
                    <img src="${data.result_images.train_batch}" alt="トレーニングバッチ" class="img-fluid">
                  </div>
                `;
              }
              
              if (data.result_images.labels) {
                imagesHtml += `
                  <div class="mb-3">
                    <h6>ラベル分布:</h6>
                    <img src="${data.result_images.labels}" alt="ラベル分布" class="img-fluid">
                  </div>
                `;
              }
              
              if (data.result_images.results) {
                imagesHtml += `
                  <div class="mb-3">
                    <h6>学習結果:</h6>
                    <img src="${data.result_images.results}" alt="学習結果" class="img-fluid">
                  </div>
                `;
              }
              
              document.getElementById('training-images').innerHTML = imagesHtml;
            }
            
            // トレーニングが完了した場合、ポーリングを停止
            if (data.status === 'completed') {
              document.getElementById('training-status').innerHTML = '<p class="text-success">トレーニングが完了しました。</p>';
              if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
              }
            } else {
              document.getElementById('training-status').innerHTML = '<p class="text-primary">トレーニングを実行中...</p>';
            }
          }
        })
        .catch(error => {
          console.error('ステータス取得エラー:', error);
        });
    }
    
    // 検出結果の表示
    function showDetectionResults(data) {
      const resultsContainer = document.getElementById('detection-results');
      resultsContainer.style.display = 'block';
      
      // 結果画像の表示
      const imageContainer = document.getElementById('result-image-container');
      if (data.result_image_path) {
        imageContainer.innerHTML = `<img src="${data.result_image_path}" alt="検出結果" class="img-fluid">`;
      } else {
        imageContainer.innerHTML = `<img src="${data.image_path}" alt="元画像" class="img-fluid">`;
      }
      
      // 検出詳細の表示
      const detailsContainer = document.getElementById('detection-details');
      let detailsHtml = `<p>${data.message}</p>`;
      
      if (data.detections && data.detections.length > 0) {
        detailsHtml += '<table class="table table-sm">';
        detailsHtml += '<thead><tr><th>#</th><th>クラス</th><th>信頼度</th><th>位置</th></tr></thead>';
        detailsHtml += '<tbody>';
        
        data.detections.forEach((detection, index) => {
          detailsHtml += `
            <tr>
              <td>${index + 1}</td>
              <td>${detection.name || '生殖乳頭'}</td>
              <td>${(detection.confidence * 100).toFixed(1)}%</td>
              <td>[${Math.round(detection.xmin)}, ${Math.round(detection.ymin)}, ${Math.round(detection.xmax)}, ${Math.round(detection.ymax)}]</td>
            </tr>
          `;
        });
        
        detailsHtml += '</tbody></table>';
      } else {
        detailsHtml += '<p class="text-muted">検出された物体はありません。</p>';
      }
      
      detailsContainer.innerHTML = detailsHtml;
    }
    
    // 初期状態の更新
    updateTrainingStatus();
  });
</script>
{% endblock %}