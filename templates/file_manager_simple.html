{% extends "base.html" %}

{% block title %}ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ - ã‚¦ãƒ‹ç”Ÿæ®–ä¹³é ­åˆ†æ{% endblock %}

{% block content %}
<style>
    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .file-manager {
        display: flex;
        gap: 20px;
        height: calc(100vh - 150px);
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .sidebar {
        width: 300px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow-y: auto;
    }

    .sidebar h3 {
        padding: 15px;
        margin: 0;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
        font-size: 1.2em;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn-sm {
        padding: 4px 8px;
        font-size: 0.85em;
        border: 1px solid #007bff;
        background: #007bff;
        color: white;
        border-radius: 3px;
        cursor: pointer;
    }

    .btn-sm:hover {
        background: #0056b3;
    }

    .folder-tree {
        padding: 15px;
    }

    .folder-item {
        padding: 8px;
        cursor: pointer;
        border-radius: 3px;
        margin-bottom: 2px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .folder-item:hover {
        background: #e8f4ff;
    }

    .folder-info {
        flex: 1;
    }

    .folder-actions {
        display: none;
        gap: 5px;
    }

    .folder-item:hover .folder-actions {
        display: flex;
    }

    .btn-icon {
        padding: 2px 6px;
        font-size: 0.8em;
        border: 1px solid #ccc;
        background: white;
        color: #333;
        border-radius: 3px;
        cursor: pointer;
    }

    .btn-icon:hover {
        background: #f0f0f0;
    }

    .folder-item.selected {
        background: #007bff;
        color: white;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main-content {
        flex: 1;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        flex-direction: column;
    }

    .main-header {
        padding: 15px;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
    }

    .main-header h3 {
        margin: 0;
        font-size: 1.2em;
    }

    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        padding: 20px;
        flex: 1;
    }

    .image-card {
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow: hidden;
        background: white;
        cursor: pointer;
        position: relative;
    }

    .image-card.selected {
        border-color: #007bff;
        background: #e7f3ff;
    }

    .image-checkbox {
        position: absolute;
        top: 10px;
        left: 10px;
        width: 20px;
        height: 20px;
        z-index: 10;
    }

    .image-card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        display: block;
    }

    .image-info {
        padding: 8px;
        font-size: 0.85em;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .label-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #28a745;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.75em;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }

    .error {
        text-align: center;
        padding: 40px;
        color: #dc3545;
    }


    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 5px;
        padding: 20px;
        min-width: 400px;
        max-width: 500px;
    }

    .modal-header {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }

    .modal-body {
        margin-bottom: 20px;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 3px;
        font-size: 0.95em;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.95em;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .action-bar {
        padding: 10px 15px;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .selection-info {
        color: #666;
    }

    .filter-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn-filter {
        padding: 6px 12px;
        border: 1px solid #dee2e6;
        background: white;
        color: #495057;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.9em;
    }

    .btn-filter.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    .btn-filter:hover:not(.active) {
        background: #f8f9fa;
    }

    .image-card.edit-mode:hover {
        border-color: #28a745;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
    }
</style>

<div class="container">
    <h2>ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h2>

    <div class="file-manager">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ•ã‚©ãƒ«ãƒ€ãƒ„ãƒªãƒ¼ï¼‰ -->
        <div class="sidebar">
            <h3>
                ãƒ•ã‚©ãƒ«ãƒ€
                <button class="btn-sm" onclick="showCreateFolderModal()">æ–°è¦</button>
            </h3>
            <div class="folder-tree" id="folderTree">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆç”»åƒè¡¨ç¤ºï¼‰ -->
        <div class="main-content">
            <div class="main-header">
                <h3 id="currentFolder">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
            </div>
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
            <div class="action-bar" id="actionBar">
                <div class="filter-buttons">
                    <button class="btn-filter" id="filterAll" onclick="setFilter('all')">
                        ã™ã¹ã¦
                    </button>
                    <button class="btn-filter" id="filterLabeled" onclick="setFilter('labeled')">
                        ãƒ©ãƒ™ãƒ«æ¸ˆã¿
                    </button>
                    <button class="btn-filter" id="filterUnlabeled" onclick="setFilter('unlabeled')">
                        æœªãƒ©ãƒ™ãƒ«
                    </button>
                    <span style="margin-left: 10px; color: #6c757d;">|</span>
                    <button class="btn-filter" onclick="toggleEditMode()" id="editModeBtn">
                        ğŸ“ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                    </button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div class="selection-info">
                        <span id="selectedCount">0</span>æšé¸æŠä¸­
                    </div>
                    <button class="btn btn-secondary" id="clearBtn" onclick="clearSelection()" disabled>é¸æŠè§£é™¤</button>
                    <button class="btn btn-primary" id="moveBtn" onclick="showMoveModal()" disabled>ç§»å‹•</button>
                    <button class="btn btn-danger" id="deleteBtn" onclick="deleteSelectedImages()" disabled>å‰Šé™¤</button>
                </div>
            </div>
            <div class="image-grid" id="imageGrid">
                <div class="loading">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            </div>
        </div>
    </div>
</div>

<!-- ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="createFolderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>æ–°è¦ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ</h3>
        </div>
        <div class="modal-body">
            <label>ãƒ•ã‚©ãƒ«ãƒ€å:</label>
            <input type="text" id="newFolderName" class="form-control" placeholder="ä¾‹: 2025_01_å®Ÿé¨“">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createFolderModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="createFolder()">ä½œæˆ</button>
        </div>
    </div>
</div>

<!-- ç”»åƒç§»å‹•ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="moveImagesModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç”»åƒã‚’ç§»å‹•</h3>
        </div>
        <div class="modal-body">
            <p><span id="moveCount">0</span>æšã®ç”»åƒã‚’ç§»å‹•ã—ã¾ã™</p>
            <label>ç§»å‹•å…ˆãƒ•ã‚©ãƒ«ãƒ€:</label>
            <select id="targetFolder" class="form-control">
                <!-- ãƒ•ã‚©ãƒ«ãƒ€ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </select>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('moveImagesModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="moveImages()">ç§»å‹•</button>
        </div>
    </div>
</div>

<!-- ãƒ•ã‚©ãƒ«ãƒ€åå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="renameFolderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ãƒ•ã‚©ãƒ«ãƒ€åå¤‰æ›´</h3>
        </div>
        <div class="modal-body">
            <label>æ–°ã—ã„åå‰:</label>
            <input type="text" id="renameFolderName" class="form-control">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('renameFolderModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn btn-primary" onclick="confirmRename()">å¤‰æ›´</button>
        </div>
    </div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentPath = '';
let selectedFolderPath = null;
let selectedFolderName = null;
let selectedImages = new Set();
let allFolders = [];
let currentFilter = 'all';
let allImages = [];
let editMode = false;

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadFolders();
});

// ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
async function loadFolders() {
    const treeContainer = document.getElementById('folderTree');

    try {
        const response = await fetch('/file-manager/api/folders');
        const data = await response.json();

        treeContainer.innerHTML = '';

        // ãƒ•ã‚©ãƒ«ãƒ€ãƒ„ãƒªãƒ¼ã‚’è¡¨ç¤º
        allFolders = [];
        collectFolders(data);
        displayFolder(data, treeContainer, 0);

    } catch (error) {
        console.error('ãƒ•ã‚©ãƒ«ãƒ€èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        treeContainer.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
    }
}

// ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’åé›†
function collectFolders(node) {
    if (!node) return;

    allFolders.push({
        path: node.path,
        name: node.name,
        level: 0
    });

    if (node.children) {
        node.children.forEach(child => {
            collectFoldersRecursive(child, 1);
        });
    }
}

function collectFoldersRecursive(node, level) {
    allFolders.push({
        path: node.path,
        name: node.name,
        level: level
    });

    if (node.children) {
        node.children.forEach(child => {
            collectFoldersRecursive(child, level + 1);
        });
    }
}

// ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¡¨ç¤ºï¼ˆå†å¸°çš„ï¼‰
function displayFolder(node, container, level) {
    if (!node) return;

    // ãƒ•ã‚©ãƒ«ãƒ€é …ç›®ã‚’ä½œæˆ
    const item = document.createElement('div');
    item.className = 'folder-item';
    item.style.paddingLeft = (level * 20 + 10) + 'px';

    // ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±éƒ¨åˆ†
    const info = document.createElement('div');
    info.className = 'folder-info';
    info.innerHTML = `ğŸ“ ${node.name} (${node.image_count || 0})`;
    info.onclick = function() {
        selectFolder(node.path, item);
    };

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆdefaultãƒ•ã‚©ãƒ«ãƒ€ä»¥å¤–ï¼‰
    const actions = document.createElement('div');
    actions.className = 'folder-actions';

    if (node.name !== 'default' && node.name !== 'datasets') {
        // åå‰å¤‰æ›´ãƒœã‚¿ãƒ³
        const renameBtn = document.createElement('button');
        renameBtn.className = 'btn-icon';
        renameBtn.innerHTML = 'âœï¸';
        renameBtn.title = 'åå‰å¤‰æ›´';
        renameBtn.onclick = function(e) {
            e.stopPropagation();
            selectedFolderPath = node.path;
            selectedFolderName = node.name;
            showRenameFolderModal();
        };

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-icon';
        deleteBtn.innerHTML = 'ğŸ—‘ï¸';
        deleteBtn.title = 'å‰Šé™¤';
        deleteBtn.onclick = function(e) {
            e.stopPropagation();
            selectedFolderPath = node.path;
            selectedFolderName = node.name;
            deleteFolder();
        };

        actions.appendChild(renameBtn);
        actions.appendChild(deleteBtn);
    }

    item.appendChild(info);
    item.appendChild(actions);

    container.appendChild(item);

    // å­ãƒ•ã‚©ãƒ«ãƒ€ã‚’è¡¨ç¤º
    if (node.children && node.children.length > 0) {
        node.children.forEach(child => {
            displayFolder(child, container, level + 1);
        });
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’è‡ªå‹•é¸æŠ
    if (node.name === 'default' && level === 1) {
        setTimeout(() => {
            selectFolder(node.path, item);
            setFilter('all');
        }, 100);
    }
}

// ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ
function selectFolder(path, element) {
    currentPath = path;

    // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.folder-item').forEach(item => {
        item.classList.remove('selected');
    });
    if (element) {
        element.classList.add('selected');
    }

    // ãƒ•ã‚©ãƒ«ãƒ€åã‚’æ›´æ–°
    document.getElementById('currentFolder').textContent =
        `ãƒ•ã‚©ãƒ«ãƒ€: ${path || 'ãƒ«ãƒ¼ãƒˆ'}`;

    // ç”»åƒã‚’èª­ã¿è¾¼ã¿
    loadImages(path);
}

// ç”»åƒã‚’èª­ã¿è¾¼ã¿
async function loadImages(path) {
    const grid = document.getElementById('imageGrid');
    grid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';

    try {
        // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
        const url = path
            ? `/file-manager/api/folder/images/${encodeURIComponent(path)}`
            : `/file-manager/api/folder/images/`;

        const response = await fetch(url);
        const data = await response.json();

        // ã‚°ãƒªãƒƒãƒ‰ã‚’ã‚¯ãƒªã‚¢
        grid.innerHTML = '';

        if (!data.images || data.images.length === 0) {
            grid.innerHTML = '<div class="loading">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</div>';
            return;
        }

        // å…¨ç”»åƒã‚’ä¿å­˜
        allImages = data.images;

        // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
        applyFilter();

    } catch (error) {
        console.error('ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        grid.innerHTML = '<div class="error">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
    }
}

// ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
function applyFilter() {
    const grid = document.getElementById('imageGrid');
    grid.innerHTML = '';

    let filteredImages = allImages;

    if (currentFilter === 'labeled') {
        filteredImages = allImages.filter(img => img.has_label);
    } else if (currentFilter === 'unlabeled') {
        filteredImages = allImages.filter(img => !img.has_label);
    }

    if (filteredImages.length === 0) {
        grid.innerHTML = '<div class="loading">è©²å½“ã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
    }

    // ç”»åƒã‚’è¡¨ç¤º
    filteredImages.forEach(image => {
            // ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
            const card = document.createElement('div');
            card.className = 'image-card';
            card.dataset.imageId = image.id;

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'image-checkbox';
            checkbox.onclick = function(e) {
                e.stopPropagation();
                toggleImageSelection(card, image.id);
            };

            // ç”»åƒ
            const img = document.createElement('img');
            img.src = image.url;
            img.alt = image.name;

            // ãƒ•ã‚¡ã‚¤ãƒ«å
            const info = document.createElement('div');
            info.className = 'image-info';
            info.textContent = image.name;

            // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯
            card.onclick = function(e) {
                if (editMode) {
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ã
                    e.preventDefault();
                    window.open(`/annotation/editor?image=${encodeURIComponent(image.name)}&folder=${encodeURIComponent(currentPath)}`, '_blank');
                } else if (e.target !== checkbox) {
                    checkbox.checked = !checkbox.checked;
                    toggleImageSelection(card, image.id);
                }
            };

            // ã‚«ãƒ¼ãƒ‰ã«è¿½åŠ 
            card.appendChild(checkbox);
            card.appendChild(img);
            card.appendChild(info);

            // ãƒ©ãƒ™ãƒ«æ¸ˆã¿ãƒãƒƒã‚¸
            if (image.has_label) {
                const badge = document.createElement('div');
                badge.className = 'label-badge';
                badge.textContent = 'âœ“';
                card.appendChild(badge);
            }

            // ã‚°ãƒªãƒƒãƒ‰ã«è¿½åŠ 
            grid.appendChild(card);
    });
}

// ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showCreateFolderModal() {
    document.getElementById('createFolderModal').classList.add('show');
    document.getElementById('newFolderName').value = '';
    document.getElementById('newFolderName').focus();
}

// ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
async function createFolder() {
    const folderName = document.getElementById('newFolderName').value.trim();

    if (!folderName) {
        alert('ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    try {
        const response = await fetch('/file-manager/api/folder/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                parent_path: '',
                folder_name: folderName
            })
        });

        const result = await response.json();

        if (response.ok) {
            closeModal('createFolderModal');
            loadFolders();
            alert('ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ');
        } else {
            alert(result.error || 'ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

// ãƒ•ã‚©ãƒ«ãƒ€åå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showRenameFolderModal() {
    document.getElementById('renameFolderModal').classList.add('show');
    document.getElementById('renameFolderName').value = selectedFolderName;
    document.getElementById('renameFolderName').focus();
}

async function confirmRename() {
    const newName = document.getElementById('renameFolderName').value.trim();

    if (!newName) {
        alert('æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    try {
        const response = await fetch('/file-manager/api/folder/rename', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                folder_path: selectedFolderPath,
                new_name: newName
            })
        });

        const result = await response.json();

        if (response.ok) {
            closeModal('renameFolderModal');
            loadFolders();
            alert('ãƒ•ã‚©ãƒ«ãƒ€åã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
        } else {
            alert(result.error || 'åå‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

// ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤
async function deleteFolder() {
    if (!selectedFolderPath) return;

    if (!confirm(`ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${selectedFolderName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    try {
        const response = await fetch('/file-manager/api/folder/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                folder_path: selectedFolderPath
            })
        });

        const result = await response.json();

        if (result.confirm_required) {
            if (confirm(result.warning + '\næœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                // å†åº¦å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                await deleteFolder();
            }
        } else if (response.ok) {
            loadFolders();
            alert('ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        } else {
            alert(result.error || 'ãƒ•ã‚©ãƒ«ãƒ€å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// ç”»åƒé¸æŠ
function toggleImageSelection(card, imageId) {
    if (selectedImages.has(imageId)) {
        selectedImages.delete(imageId);
        card.classList.remove('selected');
    } else {
        selectedImages.add(imageId);
        card.classList.add('selected');
    }

    updateActionBar();
}

// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼æ›´æ–°
function updateActionBar() {
    const selectedCount = document.getElementById('selectedCount');
    const clearBtn = document.getElementById('clearBtn');
    const moveBtn = document.getElementById('moveBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    selectedCount.textContent = selectedImages.size;

    if (selectedImages.size > 0) {
        clearBtn.disabled = false;
        moveBtn.disabled = false;
        deleteBtn.disabled = false;
    } else {
        clearBtn.disabled = true;
        moveBtn.disabled = true;
        deleteBtn.disabled = true;
    }
}

// é¸æŠè§£é™¤
function clearSelection() {
    selectedImages.clear();
    document.querySelectorAll('.image-card').forEach(card => {
        card.classList.remove('selected');
        const checkbox = card.querySelector('.image-checkbox');
        if (checkbox) checkbox.checked = false;
    });
    updateActionBar();
}

// ç”»åƒç§»å‹•ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
function showMoveModal() {
    if (selectedImages.size === 0) return;

    document.getElementById('moveCount').textContent = selectedImages.size;

    // ãƒ•ã‚©ãƒ«ãƒ€ãƒªã‚¹ãƒˆä½œæˆ
    const select = document.getElementById('targetFolder');
    select.innerHTML = '';

    allFolders.forEach(folder => {
        if (folder.path !== currentPath) {
            const option = document.createElement('option');
            option.value = folder.path;
            option.textContent = 'ã€€'.repeat(folder.level) + folder.name;
            select.appendChild(option);
        }
    });

    document.getElementById('moveImagesModal').classList.add('show');
}

// ç”»åƒç§»å‹•
async function moveImages() {
    const targetFolder = document.getElementById('targetFolder').value;
    if (!targetFolder) {
        alert('ç§»å‹•å…ˆãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    try {
        const response = await fetch('/file-manager/api/images/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                source_folder: currentPath,
                target_folder: targetFolder,
                image_ids: Array.from(selectedImages)
            })
        });

        const result = await response.json();

        if (response.ok) {
            closeModal('moveImagesModal');
            clearSelection();
            loadImages(currentPath);
            alert(`${result.moved_count}æšã®ç”»åƒã‚’ç§»å‹•ã—ã¾ã—ãŸ`);
        } else {
            alert(result.error || 'ç”»åƒç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}

// ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š
function setFilter(filter) {
    currentFilter = filter;

    // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.btn-filter').forEach(btn => {
        btn.classList.remove('active');
    });

    if (filter === 'all') {
        document.getElementById('filterAll').classList.add('active');
    } else if (filter === 'labeled') {
        document.getElementById('filterLabeled').classList.add('active');
    } else if (filter === 'unlabeled') {
        document.getElementById('filterUnlabeled').classList.add('active');
    }

    // ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
    applyFilter();
}

// ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
function toggleEditMode() {
    editMode = !editMode;
    const btn = document.getElementById('editModeBtn');

    if (editMode) {
        btn.classList.add('active');
        // é¸æŠè§£é™¤
        clearSelection();
        // ã‚«ãƒ¼ãƒ‰ã«ã‚¯ãƒ©ã‚¹è¿½åŠ 
        document.querySelectorAll('.image-card').forEach(card => {
            card.classList.add('edit-mode');
        });
    } else {
        btn.classList.remove('active');
        // ã‚«ãƒ¼ãƒ‰ã‹ã‚‰ã‚¯ãƒ©ã‚¹å‰Šé™¤
        document.querySelectorAll('.image-card').forEach(card => {
            card.classList.remove('edit-mode');
        });
    }
}

// ç”»åƒå‰Šé™¤
async function deleteSelectedImages() {
    if (selectedImages.size === 0) return;

    if (!confirm(`é¸æŠã—ãŸ${selectedImages.size}æšã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
    }

    try {
        const response = await fetch('/file-manager/api/images/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                folder_path: currentPath,
                image_ids: Array.from(selectedImages)
            })
        });

        const result = await response.json();

        if (response.ok) {
            clearSelection();
            loadImages(currentPath);
            alert(`${result.deleted_count}æšã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        } else {
            alert(result.error || 'ç”»åƒå‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    } catch (error) {
        console.error(error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
}
</script>

{% endblock %}